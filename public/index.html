<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Behavior Tracker</title>
    
    <!-- Favicon -->
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- Updated meta tag to prevent all sensor API warnings -->
    <meta http-equiv="Permissions-Policy" content="accelerometer=(), gyroscope=(), magnetometer=(), ambient-light-sensor=(), orientation-sensor=()">
    
    <!--
    PRODUCTION RECOMMENDATION: 
    For production, consider replacing these CDN links with bundled versions:
    1. Use a bundler like Webpack, Parcel, or Vite to compile React
    2. Use PostCSS to process Tailwind CSS and purge unused styles
    3. Pre-compile JSX instead of using in-browser Babel
    -->
    
    <!--React and React DOM-->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!--Babel for JSX (development only - should be precompiled for production)-->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!--p5.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    
    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="assets/css/tailwind.css">
    
    <!-- CSS for fallback animation -->
    <style>
      .simple-background {
        background: linear-gradient(-45deg, #4338ca, #3b82f6, #60a5fa, #93c5fd);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }
      
      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      
      @keyframes fall {
        0% {
          transform: translateY(-10px) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
      
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        padding: 1rem;
      }

      /* Adding new styles for emoji popup */
      .emoji-popup {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 50;
        border: 1px solid #e2e8f0;
      }

      /* Make sure the emoji popup is contained within viewport */
      @media (max-width: 400px) {
        .emoji-popup {
          width: 250px;
          left: -50px;
        }
      }

      /* Improved grid layout for emoji picker */
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }

      .emoji-item {
        height: 32px;
        width: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.1s ease;
      }

      .emoji-item:hover {
        background-color: #e0f2fe;
        transform: scale(1.1);
      }

      .emoji-search {
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin-bottom: 8px;
        width: 100%;
      }

      .emoji-category-header {
        font-weight: bold;
        font-size: 12px;
        margin: 8px 0 4px 0;
        padding-bottom: 4px;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 1;
      }
    </style>
    
    <!-- Fallback for script loading errors -->
    <script>
      window.addEventListener('error', function(e) {
        // Check if the error is related to script loading
        if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
          console.warn('Resource failed to load:', e.target.src || e.target.href);
          
          // For babel sourcemap errors, prevent further logging
          if ((e.target.src || '').includes('babel') && (e.message || '').includes('source map')) {
            console.warn('Suppressing babel source map errors');
            e.preventDefault();
          }
        }
      }, true);
    </script>
  </head>
  <body>
    <div id="root"></div>
    <div id="p5-container"></div>
    <div id="three-container"></div>

    <noscript>
      <div style="text-align: center; padding: 20px; font-family: Arial, sans-serif;">
        <h1>JavaScript Required</h1>
        <p>This application requires JavaScript to function. Please enable JavaScript in your browser settings.</p>
      </div>
    </noscript>

    <script type="text/babel" data-presets="react">
    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
      }
      
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      
      componentDidCatch(error, errorInfo) {
        console.error("React Error:", error, errorInfo);
        this.setState({ error, errorInfo });
      }
      
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: '20px', margin: '20px', border: '2px solid red', borderRadius: '5px', backgroundColor: '#fff8f8' }}>
              <h2>Something went wrong</h2>
              <details style={{ whiteSpace: 'pre-wrap', margin: '10px 0' }}>
                <summary>Show Error Details</summary>
                <p>{this.state.error && this.state.error.toString()}</p>
                <p>Component Stack: {this.state.errorInfo && this.state.errorInfo.componentStack}</p>
              </details>
              <button 
                onClick={() => window.location.reload()}
                style={{ padding: '8px 16px', backgroundColor: '#007bff', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
              >
                Reload Page
              </button>
            </div>
          );
        }
        
        return this.props.children;
      }
    }
    
    // Main App Component
    function App() {
      // Helper functions for date operations
      const formatDateKey = (date) => {
        // Ensure consistent formatting with padding for single-digit month/day
        const year = date.getFullYear();
        const month = String(date.getMonth()).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
      
      const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
      
      // Function to load behaviors from localStorage
      function loadBehaviors() {
        const behaviors = localStorage.getItem('behaviors');
        return behaviors ? JSON.parse(behaviors) : [];
      }
      
      // Function to save app state to localStorage
      function saveAppState(kids, activeKidId, kidsData) {
        localStorage.setItem('kids', JSON.stringify(kids));
        localStorage.setItem('activeKidId', activeKidId.toString());
        localStorage.setItem('kidsData', JSON.stringify(kidsData));
        console.log('App state saved to localStorage');
      }
      
      // Function to load app state from localStorage
      function loadAppState() {
        const savedKids = localStorage.getItem('kids');
        const savedActiveKidId = localStorage.getItem('activeKidId');
        const savedKidsData = localStorage.getItem('kidsData');
        
        if (savedKids && savedKidsData) {
          return {
            kids: JSON.parse(savedKids),
            activeKidId: parseInt(savedActiveKidId || '1', 10),
            kidsData: JSON.parse(savedKidsData)
          };
        }
        
        return null;
      }

      // Load saved state or use defaults
      const savedState = loadAppState();
      
      // Children management
      const [kids, setKids] = React.useState(savedState?.kids || [{ id: 1, name: "My Kid", avatar: "ðŸ‘§" }]);
      const [activeKidId, setActiveKidId] = React.useState(savedState?.activeKidId || 1);
      const [showKidManager, setShowKidManager] = React.useState(false);
      const [newKid, setNewKid] = React.useState({ name: "", avatar: "ðŸ‘¶" });
      const [isAddingKid, setIsAddingKid] = React.useState(false);
      
      // Individual kid data
      const [kidsData, setKidsData] = React.useState(savedState?.kidsData || {
        1: {
          points: 0,
          behaviors: {},
          dailyBehaviorLogs: {},
          goodBehaviors: [
            { id: 1, description: "Cleaning up toys", points: 2, icon: "ðŸ§¹" },
            { id: 2, description: "Helping a sibling", points: 3, icon: "ðŸ¤" },
            { id: 3, description: "Completing homework", points: 2, icon: "ðŸ“š" },
            { id: 4, description: "Brushing teeth without reminder", points: 1, icon: "ðŸª¥" },
            { id: 5, description: "Setting the table", points: 1, icon: "ðŸ½ï¸" }
          ],
          badBehaviors: [
            { id: 1, description: "Not listening", points: 1, icon: "ðŸ‘‚" },
            { id: 2, description: "Fighting with siblings", points: 2, icon: "ðŸ˜ " },
            { id: 3, description: "Not finishing food", points: 1, icon: "ðŸ½ï¸" },
            { id: 4, description: "Screen time without permission", points: 2, icon: "ðŸ“±" },
            { id: 5, description: "Bedtime tantrum", points: 3, icon: "ðŸ˜­" }
          ],
          rewards: [
            { id: 1, name: "Playground Time", points: 20, claimed: false, icon: "ðŸ›" },
            { id: 2, name: "Ice Cream", points: 30, claimed: false, icon: "ðŸ¦" },
            { id: 3, name: "Movie Night", points: 50, claimed: false, icon: "ðŸŽ¬" },
            { id: 4, name: "New Toy", points: 100, claimed: false, icon: "ðŸ§¸" }
          ]
        }
      });

      const [currentDate, setCurrentDate] = React.useState(new Date());
      const [selectedDate, setSelectedDate] = React.useState(new Date());
      const [newReward, setNewReward] = React.useState({ name: "", points: 0, icon: "ðŸŽ" });
      const [isAddingReward, setIsAddingReward] = React.useState(false);
      const [activeBehavior, setActiveBehavior] = React.useState("good");
      const [showConfetti, setShowConfetti] = React.useState(false);
      // Flag to disable p5.js if it causes issues
      const [useSimpleBackground, setUseSimpleBackground] = React.useState(false);

      // State for managing behaviors and other UI elements
      const [savedBehaviors, setSavedBehaviors] = React.useState(loadBehaviors() || []);
      const [showIconPicker, setShowIconPicker] = React.useState(false);
      const [newBehavior, setNewBehavior] = React.useState({
        name: '',
        icon: '',
        pointValue: 1,
        description: '',
        trackFrequency: false
      });
      const [isAddingBehavior, setIsAddingBehavior] = React.useState(false);
      
      // Reference for the icon picker element
      const iconPickerRef = React.useRef(null);
      
      // Add event listener to close emoji picker when clicking outside
      React.useEffect(() => {
        function handleClickOutside(event) {
          if (showIconPicker && iconPickerRef.current && !iconPickerRef.current.contains(event.target)) {
            setShowIconPicker(false);
          }
        }
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
        };
      }, [showIconPicker]);
      
      // Track currently selected behaviors
      const [selectedGoodBehavior, setSelectedGoodBehavior] = React.useState(null);
      const [selectedBadBehavior, setSelectedBadBehavior] = React.useState(null);

      // Show/hide behavior lists
      const [showBehaviorManager, setShowBehaviorManager] = React.useState(false);

      // Add state to force re-renders
      const [renderTrigger, setRenderTrigger] = React.useState(0);

      // Add state for behavior type selection
      const [behaviorTypeToAdd, setBehaviorTypeToAdd] = React.useState("good");
      
      // Add state for icon picker
      const [iconCategories, setIconCategories] = React.useState([
        {
          name: "Faces",
          icons: ["ðŸ˜Š", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜", "ðŸ¥°", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜™", "ðŸ˜š", "ðŸ˜‹", "ðŸ˜›", "ðŸ˜œ", "ðŸ˜", "ðŸ¤‘", "ðŸ¤—", "ðŸ¤”", "ðŸ¤", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¶", "ðŸ˜", "ðŸ˜’", "ðŸ™„", "ðŸ˜¬", "ðŸ¤¥", "ðŸ˜Œ", "ðŸ˜”", "ðŸ˜ª", "ðŸ¤¤", "ðŸ˜´", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•", "ðŸ¤¢", "ðŸ¤®", "ðŸ¤§", "ðŸ˜µ", "ðŸ¤¯", "ðŸ¥³", "ðŸ˜Ž", "ðŸ§", "ðŸ˜•", "ðŸ˜Ÿ", "ðŸ™", "â˜¹ï¸", "ðŸ˜®", "ðŸ˜¯", "ðŸ˜²", "ðŸ˜³", "ðŸ¥º", "ðŸ˜¦", "ðŸ˜§", "ðŸ˜¨", "ðŸ˜°", "ðŸ˜¥", "ðŸ˜¢", "ðŸ˜­", "ðŸ˜±", "ðŸ˜–", "ðŸ˜£", "ðŸ˜ž", "ðŸ˜“", "ðŸ˜©", "ðŸ˜«", "ðŸ¥±", "ðŸ˜¤", "ðŸ˜¡", "ðŸ˜ ", "ðŸ¤¬", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ’€", "â˜ ï¸", "ðŸ’©", "ðŸ¤¡", "ðŸ‘¹", "ðŸ‘º", "ðŸ‘»", "ðŸ‘½", "ðŸ‘¾", "ðŸ¤–"]
        },
        {
          name: "Animals",
          icons: ["ðŸ¶", "ðŸ±", "ðŸ­", "ðŸ¹", "ðŸ°", "ðŸ¦Š", "ðŸ»", "ðŸ¼", "ðŸ¨", "ðŸ¯", "ðŸ¦", "ðŸ®", "ðŸ·", "ðŸ¸", "ðŸµ", "ðŸ”", "ðŸ§", "ðŸ¦", "ðŸ¤", "ðŸ£", "ðŸ¥", "ðŸ¦†", "ðŸ¦…", "ðŸ¦‰", "ðŸ¦‡", "ðŸº", "ðŸ—", "ðŸ´", "ðŸ¦„", "ðŸ", "ðŸ›", "ðŸ¦‹", "ðŸŒ", "ðŸž", "ðŸœ", "ðŸ¦Ÿ", "ðŸ¦—", "ðŸ•·", "ðŸ•¸", "ðŸ¦‚", "ðŸ¢", "ðŸ", "ðŸ¦Ž", "ðŸ¦–", "ðŸ¦•", "ðŸ™", "ðŸ¦‘", "ðŸ¦", "ðŸ¦ž", "ðŸ¦€", "ðŸ¡", "ðŸ ", "ðŸŸ", "ðŸ¬", "ðŸ³", "ðŸ‹", "ðŸ¦ˆ", "ðŸŠ", "ðŸ…", "ðŸ†", "ðŸ¦“", "ðŸ¦", "ðŸ¦§", "ðŸ˜", "ðŸ¦›", "ðŸ¦", "ðŸª", "ðŸ«", "ðŸ¦’", "ðŸ¦˜", "ðŸƒ", "ðŸ‚", "ðŸ„", "ðŸŽ", "ðŸ–", "ðŸ", "ðŸ‘", "ðŸ¦™", "ðŸ", "ðŸ¦Œ", "ðŸ•", "ðŸ©", "ðŸ¦®", "ðŸ•â€ðŸ¦º", "ðŸˆ", "ðŸ“", "ðŸ¦ƒ", "ðŸ¦š", "ðŸ¦œ", "ðŸ¦¢", "ðŸ¦©", "ðŸ•Š", "ðŸ‡", "ðŸ¦", "ðŸ¦¨", "ðŸ¦¡", "ðŸ¦¦", "ðŸ¦¥", "ðŸ", "ðŸ€", "ðŸ¿", "ðŸ¦”"]
        },
        {
          name: "Objects",
          icons: ["â­", "ðŸŒŸ", "âœ¨", "ðŸ’«", "ðŸª„", "ðŸ”®", "ðŸŽ®", "ðŸŽ²", "ðŸ§¸", "ðŸª…", "ðŸª†", "ðŸ§©", "ðŸŽ¨", "ðŸ§µ", "ðŸ§¶", "ðŸŽ­", "ðŸŽ°", "ðŸŽª", "ðŸŽª", "ðŸŽ­", "ðŸŽ¨", "ðŸ§µ", "ðŸ§¶", "ðŸŽ®", "ðŸŽ²", "ðŸ§©", "ðŸ§¸", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥", "ðŸ–¨", "ðŸ–±", "ðŸ–²", "ðŸ•¹", "ðŸ—œ", "ðŸ’½", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½", "ðŸŽž", "ðŸ“ž", "â˜Žï¸", "ðŸ“Ÿ", "ðŸ“ ", "ðŸ“º", "ðŸ“»", "ðŸŽ™", "ðŸŽš", "ðŸŽ›", "ðŸ§­", "â±", "â²", "â°", "ðŸ•°", "âŒ›", "â³", "ðŸ“¡", "ðŸ”‹", "ðŸ”Œ", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯", "ðŸª”", "ðŸ§¯", "ðŸ›¢", "ðŸ’¸", "ðŸ’µ", "ðŸ’´", "ðŸ’¶", "ðŸ’·", "ðŸ’°", "ðŸ’³", "ðŸ’Ž", "âš–ï¸", "ðŸ§°", "ðŸ”§", "ðŸ”¨", "âš’", "ðŸ› ", "â›", "ðŸ”©", "âš™ï¸", "ðŸ§±", "â›“", "ðŸ§²", "ðŸ”«", "ðŸ’£", "ðŸ§¨", "ðŸª“", "ðŸ”ª", "ðŸ—¡", "âš”ï¸", "ðŸ›¡", "ðŸš¬", "âš°ï¸", "âš±ï¸", "ðŸº", "ðŸ”®", "ðŸ“¿", "ðŸ§¿", "ðŸ’ˆ", "âš—ï¸", "ðŸ”­", "ðŸ”¬", "ðŸ•³", "ðŸ©¹", "ðŸ©º", "ðŸ’Š", "ðŸ’‰", "ðŸ©¸", "ðŸ§¬", "ðŸ¦ ", "ðŸ§«", "ðŸ§ª", "ðŸŒ¡", "ðŸ§¹", "ðŸ§º", "ðŸ§»", "ðŸš½", "ðŸš°", "ðŸš¿", "ðŸ›", "ðŸ›€", "ðŸ§¼", "ðŸª’", "ðŸ§½", "ðŸ§´", "ðŸ›Ž", "ðŸ”‘", "ðŸ—", "ðŸšª", "ðŸª‘", "ðŸ›‹", "ðŸ›", "ðŸ›Œ", "ðŸ§¸", "ðŸ–¼", "ðŸ›", "ðŸ›’", "ðŸŽ", "ðŸŽˆ", "ðŸŽ", "ðŸŽ€", "ðŸŽŠ", "ðŸŽ‰", "ðŸŽŽ", "ðŸ®", "ðŸŽ", "ðŸ§§", "âœ‰ï¸", "ðŸ“©", "ðŸ“¨", "ðŸ“§", "ðŸ’Œ", "ðŸ“¥", "ðŸ“¤", "ðŸ“¦", "ðŸ·", "ðŸ“ª", "ðŸ“«", "ðŸ“¬", "ðŸ“­", "ðŸ“®", "ðŸ“¯", "ðŸ“œ", "ðŸ“ƒ", "ðŸ“„", "ðŸ“‘", "ðŸ§¾", "ðŸ“Š", "ðŸ“ˆ", "ðŸ“‰", "ðŸ—’", "ðŸ—“", "ðŸ“†", "ðŸ“…", "ðŸ—‘", "ðŸ“‡", "ðŸ—ƒ", "ðŸ—³", "ðŸ—„", "ðŸ“‹", "ðŸ“", "ðŸ“‚", "ðŸ—‚", "ðŸ—ž", "ðŸ“°", "ðŸ““", "ðŸ“”", "ðŸ“’", "ðŸ“•", "ðŸ“—", "ðŸ“˜", "ðŸ“™", "ðŸ“š", "ðŸ“–", "ðŸ”–", "ðŸ§·", "ðŸ”—", "ðŸ“Ž", "ðŸ–‡", "ðŸ“", "ðŸ“", "ðŸ§®", "ðŸ“Œ", "ðŸ“", "âœ‚ï¸", "ðŸ–Š", "ðŸ–‹", "âœ’ï¸", "ðŸ–Œ", "ðŸ–", "ðŸ“", "âœï¸", "ðŸ”", "ðŸ”Ž", "ðŸ”", "ðŸ”", "ðŸ”’", "ðŸ”“"]
        },
        {
          name: "Activities",
          icons: ["ðŸŽ¯", "ðŸŽ®", "ðŸŽ²", "ðŸ§©", "ðŸŽ­", "ðŸŽ¨", "ðŸ‘Ÿ", "ðŸ†", "ðŸ…", "ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰", "âš½", "âš¾", "ðŸ€", "ðŸ", "ðŸˆ", "ðŸ‰", "ðŸŽ¾", "ðŸ¥", "ðŸŽ³", "ðŸ", "ðŸ‘", "ðŸ’", "ðŸ¥", "ðŸ“", "ðŸ¸", "ðŸ¥Š", "ðŸ¥‹", "ðŸ¥…", "â›³", "â›¸", "ðŸŽ£", "ðŸ¤¿", "ðŸŽ½", "ðŸŽ¿", "ðŸ›·", "ðŸ¥Œ", "ðŸŽ¯", "ðŸª€", "ðŸª", "ðŸŽ±", "ðŸ”®", "ðŸ§¿", "ðŸŽ®", "ðŸŽ°", "ðŸŽ²", "ðŸ§©", "ðŸ§¸", "â™Ÿï¸", "ðŸŽ­", "ðŸŽ¨", "ðŸ§µ", "ðŸ§¶", "ðŸ‘“", "ðŸ•¶", "ðŸ¥½", "ðŸ¥¼", "ðŸ¦º", "ðŸ‘”", "ðŸ‘•", "ðŸ‘–", "ðŸ§£", "ðŸ§¤", "ðŸ§¥", "ðŸ§¦", "ðŸ‘—", "ðŸ‘˜", "ðŸ¥»", "ðŸ©±", "ðŸ©²", "ðŸ©³", "ðŸ‘™", "ðŸ‘š", "ðŸ‘›", "ðŸ‘œ", "ðŸ‘", "ðŸ›", "ðŸŽ’", "ðŸ‘ž", "ðŸ‘Ÿ", "ðŸ¥¾", "ðŸ¥¿", "ðŸ‘ ", "ðŸ‘¡", "ðŸ©°", "ðŸ‘¢", "ðŸ‘‘", "ðŸ‘’", "ðŸŽ©", "ðŸŽ“", "ðŸ§¢", "â›‘", "ðŸ“¿", "ðŸ’„", "ðŸ’", "ðŸ’Ž", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥", "ðŸ–¨", "ðŸ–±", "ðŸ–²", "ðŸ•¹", "ðŸ—œ", "ðŸ’½", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½", "ðŸŽž", "ðŸ“ž", "â˜Žï¸", "ðŸ“Ÿ", "ðŸ“ ", "ðŸ“º", "ðŸ“»", "ðŸŽ™", "ðŸŽš", "ðŸŽ›", "ðŸ§­", "â±", "â²", "â°", "ðŸ•°", "âŒ›", "â³", "ðŸ“¡", "ðŸ”‹", "ðŸ”Œ", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯", "ðŸª”", "ðŸ§¯", "ðŸ›¢", "ðŸ’¸", "ðŸ’µ", "ðŸ’´", "ðŸ’¶", "ðŸ’·", "ðŸ’°", "ðŸ’³", "ðŸ’Ž", "âš–ï¸", "ðŸ§°", "ðŸ”§", "ðŸ”¨", "âš’", "ðŸ› ", "â›", "ðŸ”©", "âš™ï¸", "ðŸ§±", "â›“", "ðŸ§²", "ðŸ”«", "ðŸ’£", "ðŸ§¨", "ðŸª“", "ðŸ”ª", "ðŸ—¡", "âš”ï¸", "ðŸ›¡"]
        },
        {
          name: "Food",
          icons: ["ðŸ", "ðŸŽ", "ðŸ", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ‰", "ðŸ‡", "ðŸ“", "ðŸˆ", "ðŸ’", "ðŸ‘", "ðŸ¥­", "ðŸ", "ðŸ¥¥", "ðŸ¥", "ðŸ…", "ðŸ†", "ðŸ¥‘", "ðŸ¥¦", "ðŸ¥¬", "ðŸ¥’", "ðŸŒ¶", "ðŸŒ½", "ðŸ¥•", "ðŸ§„", "ðŸ§…", "ðŸ¥”", "ðŸ ", "ðŸ¥", "ðŸ¥¯", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥ž", "ðŸ§‡", "ðŸ¥“", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸ¦´", "ðŸŒ­", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸ¥ª", "ðŸ¥™", "ðŸ§†", "ðŸŒ®", "ðŸŒ¯", "ðŸ¥—", "ðŸ¥˜", "ðŸ¥«", "ðŸ", "ðŸœ", "ðŸ²", "ðŸ›", "ðŸ£", "ðŸ±", "ðŸ¥Ÿ", "ðŸ¦ª", "ðŸ¤", "ðŸ™", "ðŸš", "ðŸ˜", "ðŸ¥", "ðŸ¥ ", "ðŸ¥®", "ðŸ¢", "ðŸ¡", "ðŸ§", "ðŸ¨", "ðŸ¦", "ðŸ¥§", "ðŸ§", "ðŸ°", "ðŸŽ‚", "ðŸ®", "ðŸ­", "ðŸ¬", "ðŸ«", "ðŸ¿", "ðŸ©", "ðŸª", "ðŸŒ°", "ðŸ¥œ", "ðŸ¯", "ðŸ¥›", "ðŸ¼", "â˜•", "ðŸµ", "ðŸ§ƒ", "ðŸ¥¤", "ðŸ¶", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ·", "ðŸ¥ƒ", "ðŸ¸", "ðŸ¹", "ðŸ§‰", "ðŸ¾", "ðŸ§Š", "ðŸ¥„", "ðŸ´", "ðŸ½", "ðŸ¥£", "ðŸ¥¡", "ðŸ¥¢", "ðŸ§‚"]
        },
        {
          name: "Travel",
          icons: ["ðŸš—", "ðŸš•", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸŽ", "ðŸš“", "ðŸš‘", "ðŸš’", "ðŸš", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸ¦¯", "ðŸ¦½", "ðŸ¦¼", "ðŸ›´", "ðŸš²", "ðŸ›µ", "ðŸ", "ðŸ›º", "ðŸš¨", "ðŸš”", "ðŸš", "ðŸš˜", "ðŸš–", "ðŸš¡", "ðŸš ", "ðŸšŸ", "ðŸšƒ", "ðŸš‹", "ðŸšž", "ðŸš", "ðŸš„", "ðŸš…", "ðŸšˆ", "ðŸš‚", "ðŸš†", "ðŸš‡", "ðŸšŠ", "ðŸš‰", "âœˆï¸", "ðŸ›«", "ðŸ›¬", "ðŸ›©", "ðŸ’º", "ðŸ›°", "ðŸš€", "ðŸ›¸", "ðŸš", "ðŸ›¶", "â›µ", "ðŸš¤", "ðŸ›¥", "ðŸ›³", "â›´", "ðŸš¢", "âš“", "â›½", "ðŸš§", "ðŸš¦", "ðŸš¥", "ðŸš", "ðŸ—º", "ðŸ—¿", "ðŸ—½", "ðŸ—¼", "ðŸ°", "ðŸ¯", "ðŸŸ", "ðŸŽ¡", "ðŸŽ¢", "ðŸŽ ", "â›²", "â›±", "ðŸ–", "ðŸ", "ðŸœ", "ðŸŒ‹", "â›°", "ðŸ”", "ðŸ—»", "ðŸ•", "â›º", "ðŸ ", "ðŸ¡", "ðŸ˜", "ðŸš", "ðŸ—", "ðŸ­", "ðŸ¢", "ðŸ¬", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸª", "ðŸ«", "ðŸ©", "ðŸ’’", "ðŸ›", "â›ª", "ðŸ•Œ", "ðŸ•", "ðŸ›•", "ðŸ•‹", "â›©", "ðŸ›¤", "ðŸ›£", "ðŸ—¾", "ðŸŽ‘", "ðŸž", "ðŸŒ…", "ðŸŒ„", "ðŸŒ ", "ðŸŽ‡", "ðŸŽ†", "ðŸŒ‡", "ðŸŒ†", "ðŸ™", "ðŸŒƒ", "ðŸŒŒ", "ðŸŒ‰", "ðŸŒ"]
        },
        {
          name: "Symbols",
          icons: ["â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ’™", "ðŸ’œ", "ðŸ–¤", "ðŸ¤", "ðŸ¤Ž", "ðŸ’”", "â£ï¸", "ðŸ’•", "ðŸ’ž", "ðŸ’“", "ðŸ’—", "ðŸ’–", "ðŸ’˜", "ðŸ’", "ðŸ’Ÿ", "â˜®ï¸", "âœï¸", "â˜ªï¸", "ðŸ•‰", "â˜¸ï¸", "âœ¡ï¸", "ðŸ”¯", "ðŸ•Ž", "â˜¯ï¸", "â˜¦ï¸", "ðŸ›", "â›Ž", "â™ˆ", "â™‰", "â™Š", "â™‹", "â™Œ", "â™", "â™Ž", "â™", "â™", "â™‘", "â™’", "â™“", "ðŸ†”", "âš›ï¸", "ðŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ðŸ“´", "ðŸ“³", "ðŸˆ¶", "ðŸˆš", "ðŸˆ¸", "ðŸˆº", "ðŸˆ·ï¸", "âœ´ï¸", "ðŸ†š", "ðŸ’®", "ðŸ‰", "ãŠ™ï¸", "ãŠ—ï¸", "ðŸˆ´", "ðŸˆµ", "ðŸˆ¹", "ðŸˆ²", "ðŸ…°ï¸", "ðŸ…±ï¸", "ðŸ†Ž", "ðŸ†‘", "ðŸ…¾ï¸", "ðŸ†˜", "âŒ", "â­•", "ðŸ›‘", "â›”", "ðŸ“›", "ðŸš«", "ðŸ’¯", "ðŸ’¢", "â™¨ï¸", "ðŸš·", "ðŸš¯", "ðŸš³", "ðŸš±", "ðŸ”ž", "ðŸ“µ", "ðŸš­", "â—", "â•", "â“", "â”", "â€¼ï¸", "â‰ï¸", "ðŸ”…", "ðŸ”†", "ã€½ï¸", "âš ï¸", "ðŸš¸", "ðŸ”±", "âšœï¸", "ðŸ”°", "â™»ï¸", "âœ…", "ðŸˆ¯", "ðŸ’¹", "â‡ï¸", "âœ³ï¸", "âŽ", "ðŸŒ", "ðŸ’ ", "â“‚ï¸", "ðŸŒ€", "ðŸ’¤", "ðŸ§", "ðŸš¾", "â™¿", "ðŸ…¿ï¸", "ðŸˆ³", "ðŸˆ‚ï¸", "ðŸ›‚", "ðŸ›ƒ", "ðŸ›„", "ðŸ›…", "ðŸš¹", "ðŸšº", "ðŸš¼", "âš§", "ðŸš»", "ðŸš®", "ðŸŽ¦", "ðŸ“¶", "ðŸˆ", "ðŸ”£", "â„¹ï¸", "ðŸ”¤", "ðŸ”¡", "ðŸ” ", "ðŸ†–", "ðŸ†—", "ðŸ†™", "ðŸ†’", "ðŸ†•", "ðŸ†“", "0ï¸âƒ£", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ðŸ”Ÿ", "ðŸ”¢", "#ï¸âƒ£", "*ï¸âƒ£", "âï¸", "â–¶ï¸", "â¸", "â¯", "â¹", "âº", "â­", "â®", "â©", "âª", "â«", "â¬", "â—€ï¸", "ðŸ”¼", "ðŸ”½", "âž¡ï¸", "â¬…ï¸", "â¬†ï¸", "â¬‡ï¸", "â†—ï¸", "â†˜ï¸", "â†™ï¸", "â†–ï¸", "â†•ï¸", "â†”ï¸", "â†ªï¸", "â†©ï¸", "â¤´ï¸", "â¤µï¸", "ðŸ”€", "ðŸ”", "ðŸ”‚", "ðŸ”„", "ðŸ”ƒ", "ðŸŽµ", "ðŸŽ¶", "âž•", "âž–", "âž—", "âœ–ï¸", "â™¾", "ðŸ’²", "ðŸ’±", "â„¢ï¸", "Â©ï¸", "Â®ï¸", "ã€°ï¸", "âž°", "âž¿", "ðŸ”š", "ðŸ”™", "ðŸ”›", "ðŸ”", "ðŸ”œ", "âœ”ï¸", "â˜‘ï¸", "ðŸ”˜", "ðŸ”´", "ðŸŸ ", "ðŸŸ¡", "ðŸŸ¢", "ðŸ”µ", "ðŸŸ£", "âš«", "âšª", "ðŸŸ¤", "ðŸ”º", "ðŸ”»", "ðŸ”¸", "ðŸ”¹", "ðŸ”¶", "ðŸ”·", "ðŸ”³", "ðŸ”²", "â–ªï¸", "â–«ï¸", "â—¾", "â—½", "â—¼ï¸", "â—»ï¸", "ðŸŸ¥", "ðŸŸ§", "ðŸŸ¨", "ðŸŸ©", "ðŸŸ¦", "ðŸŸª", "â¬›", "â¬œ", "ðŸŸ«", "ðŸ”ˆ", "ðŸ”‡", "ðŸ”‰", "ðŸ”Š", "ðŸ””", "ðŸ”•", "ðŸ“£", "ðŸ“¢", "ðŸ‘â€ðŸ—¨", "ðŸ’¬", "ðŸ’­", "ðŸ—¯", "â™ ï¸", "â™£ï¸", "â™¥ï¸", "â™¦ï¸", "ðŸƒ", "ðŸŽ´", "ðŸ€„", "ðŸ•", "ðŸ•‘", "ðŸ•’", "ðŸ•“", "ðŸ•”", "ðŸ••", "ðŸ•–", "ðŸ•—", "ðŸ•˜", "ðŸ•™", "ðŸ•š", "ðŸ•›", "ðŸ•œ", "ðŸ•", "ðŸ•ž", "ðŸ•Ÿ", "ðŸ• ", "ðŸ•¡", "ðŸ•¢", "ðŸ•£", "ðŸ•¤", "ðŸ•¥", "ðŸ•¦", "ðŸ•§"]
        }
      ]);

      // Add state for emoji search
      const [emojiSearchTerm, setEmojiSearchTerm] = React.useState('');
      const [filteredCategories, setFilteredCategories] = React.useState([]);
      
      // Function to filter emojis based on search term
      React.useEffect(() => {
        if (!emojiSearchTerm.trim()) {
          setFilteredCategories(iconCategories);
          return;
        }
        
        const filtered = iconCategories.map(category => {
          return {
            name: category.name,
            icons: category.icons.filter(icon => 
              // Simple search by checking if the emoji contains the search term
              icon.toLowerCase().includes(emojiSearchTerm.toLowerCase())
            )
          };
        }).filter(category => category.icons.length > 0);
        
        setFilteredCategories(filtered);
      }, [emojiSearchTerm, iconCategories]);

      // Get the active kid's data
      const activeKid = kids.find(kid => kid.id === activeKidId) || kids[0];
      const activeKidData = kidsData[activeKidId] || kidsData[1];
      
      // Shorthand getters/setters for active kid's data
      const currentPoints = activeKidData.points;
      const setCurrentPoints = (pointsUpdater) => {
        const newPoints = typeof pointsUpdater === 'function' 
          ? pointsUpdater(activeKidData.points) 
          : pointsUpdater;
        
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          points: newPoints
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // Debug log
        console.log(`Updated points for kid ${activeKidId}: ${newPoints}`);
      };
      
      const behaviors = activeKidData.behaviors;
      const setBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.behaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          behaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // IMPORTANT: Force a re-render after state update
        setTimeout(() => {
          console.log("Updated behaviors state:", kidsData[activeKidId].behaviors);
        }, 0);
        
        // Debug log
        console.log(`Updated behaviors for kid ${activeKidId}:`, newBehaviors);
      };
      
      const dailyBehaviorLogs = activeKidData.dailyBehaviorLogs;
      const setDailyBehaviorLogs = (logsUpdater) => {
        const newLogs = typeof logsUpdater === 'function'
          ? logsUpdater(activeKidData.dailyBehaviorLogs)
          : logsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          dailyBehaviorLogs: newLogs
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // Debug log
        console.log(`Updated daily logs for kid ${activeKidId}:`, newLogs);
      };
      
      const goodBehaviors = activeKidData.goodBehaviors;
      const setGoodBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.goodBehaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          goodBehaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };
      
      const badBehaviors = activeKidData.badBehaviors;
      const setBadBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.badBehaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          badBehaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };
      
      const rewards = activeKidData.rewards;
      const setRewards = (rewardsUpdater) => {
        const newRewards = typeof rewardsUpdater === 'function'
          ? rewardsUpdater(activeKidData.rewards)
          : rewardsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          rewards: newRewards
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };

      // Function to remove a behavior from daily logs
      const removeBehavior = (logId) => {
        // Ask for confirmation before removing
        if (confirm("Are you sure you want to remove this behavior?")) {
          const dateKey = formatDateKey(selectedDate);
          
          console.log(`REMOVING BEHAVIOR - Log ID: ${logId}, Date: ${dateKey}`);
          
          // Get current kid data directly from state to ensure we have the latest
          const currentKidData = {...kidsData[activeKidId]};
          
          // Get current logs for this date
          const currentDateLogs = currentKidData.dailyBehaviorLogs[dateKey] || [];
          
          // Find the log entry to be removed
          const logToRemove = currentDateLogs.find(log => log.id === logId);
          
          if (logToRemove) {
            console.log(`REMOVING - Found log to remove:`, logToRemove);
            
            // Adjust points based on the removed behavior
            const pointsAdjustment = logToRemove.type === 'good' 
              ? -logToRemove.points  // Subtract points for good behavior
              : logToRemove.points;  // Add back points for bad behavior
            
            // Update daily behavior counts
            const currentDayBehaviors = currentKidData.behaviors[dateKey] || { good: 0, bad: 0 };
            const updatedDayBehaviors = {
              ...currentDayBehaviors,
              [logToRemove.type]: Math.max(0, (currentDayBehaviors[logToRemove.type] || 0) - 1)
            };
            
            console.log(`REMOVING - Updating day behaviors from`, currentDayBehaviors, `to`, updatedDayBehaviors);
            
            // Create updated logs with the behavior removed
            const updatedLogs = currentDateLogs.filter(log => log.id !== logId);
            
            // Create a single updated kid data object with all changes
            const updatedKidData = {
              ...currentKidData,
              points: currentKidData.points + pointsAdjustment,
              behaviors: {
                ...currentKidData.behaviors,
                [dateKey]: updatedDayBehaviors
              },
              dailyBehaviorLogs: {
                ...currentKidData.dailyBehaviorLogs,
                [dateKey]: updatedLogs
              }
            };
            
            // Update all kid data in a single operation
            setKidsData({
              ...kidsData,
              [activeKidId]: updatedKidData
            });
            
            console.log(`REMOVING - Updated kid data:`, updatedKidData);
            console.log(`REMOVING - Adjusting points by ${pointsAdjustment}, new total: ${updatedKidData.points}`);
            
            // Force immediate UI refresh
            setRenderTrigger(prev => prev + 1);
            
            // Force another UI refresh after a small delay to ensure changes are visible
            setTimeout(() => {
              console.log("VERIFYING REMOVAL - Checking if UI has updated");
              
              // Verify the current state after the update
              console.log("Current kid data:", kidsData[activeKidId]);
              console.log(`Current behaviors for ${dateKey}:`, kidsData[activeKidId]?.behaviors?.[dateKey]);
              console.log(`Current logs for ${dateKey}:`, kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey]);
              
              // Force another render update
              setRenderTrigger(prev => prev + 1);
              
              // Also force a date change to trigger calendar-related updates
              const refreshDate = new Date(selectedDate);
              refreshDate.setMilliseconds(refreshDate.getMilliseconds() + 1);
              setSelectedDate(refreshDate);
            }, 50);
          }
        }
      };

      // Kid management functions
      const addKid = () => {
        if (newKid.name) {
          const newKidId = Math.max(0, ...kids.map(k => k.id)) + 1;
          
          // Add new kid to kids list
          setKids([...kids, { ...newKid, id: newKidId }]);
          
          // Initialize data structure for the new kid
          setKidsData({
            ...kidsData,
            [newKidId]: {
              points: 0,
              behaviors: {},
              dailyBehaviorLogs: {},
              goodBehaviors: [
                { id: 1, description: "Cleaning up toys", points: 2, icon: "ðŸ§¹" },
                { id: 2, description: "Helping a sibling", points: 3, icon: "ðŸ¤" },
                { id: 3, description: "Completing homework", points: 2, icon: "ðŸ“š" },
                { id: 4, description: "Brushing teeth without reminder", points: 1, icon: "ðŸª¥" },
                { id: 5, description: "Setting the table", points: 1, icon: "ðŸ½ï¸" }
              ],
              badBehaviors: [
                { id: 1, description: "Not listening", points: 1, icon: "ðŸ‘‚" },
                { id: 2, description: "Fighting with siblings", points: 2, icon: "ðŸ˜ " },
                { id: 3, description: "Not finishing food", points: 1, icon: "ðŸ½ï¸" },
                { id: 4, description: "Screen time without permission", points: 2, icon: "ðŸ“±" },
                { id: 5, description: "Bedtime tantrum", points: 3, icon: "ðŸ˜­" }
              ],
              rewards: [
                { id: 1, name: "Playground Time", points: 20, claimed: false, icon: "ðŸ›" },
                { id: 2, name: "Ice Cream", points: 30, claimed: false, icon: "ðŸ¦" },
                { id: 3, name: "Movie Night", points: 50, claimed: false, icon: "ðŸŽ¬" },
                { id: 4, name: "New Toy", points: 100, claimed: false, icon: "ðŸ§¸" }
              ]
            }
          });
          
          // Reset form
          setNewKid({ name: "", avatar: "ðŸ‘¶" });
          setIsAddingKid(false);
          
          // Switch to the new kid
          setActiveKidId(newKidId);
        }
      };
      
      const editKid = (id, updatedKid) => {
        setKids(kids.map(kid => 
          kid.id === id ? { ...kid, ...updatedKid } : kid
        ));
      };
      
      const deleteKid = (id) => {
        // Don't allow deleting the last kid
        if (kids.length <= 1) {
          alert("You must have at least one child in the tracker.");
          return;
        }
        
        // Confirm before deletion
        if (!confirm(`Are you sure you want to delete ${kids.find(k => k.id === id)?.name}?`)) {
          return;
        }
        
        // Remove the kid
        setKids(kids.filter(kid => kid.id !== id));
        
        // If the active kid was deleted, switch to another kid
        if (activeKidId === id) {
          const remainingKidId = kids.find(kid => kid.id !== id)?.id || kids[0].id;
          setActiveKidId(remainingKidId);
        }
        
        // Remove the kid's data
        const { [id]: _, ...remainingKidsData } = kidsData;
        setKidsData(remainingKidsData);
      };
      
      // Switch active kid
      const switchKid = (id) => {
        console.log(`Switching from kid ${activeKidId} to kid ${id}`);
        
        // Get current kid data
        const currentKidData = kidsData[id] || {};
        console.log(`New kid's data:`, currentKidData);
        
        setActiveKidId(id);
        
        // Reset behavior selections when switching
        setSelectedGoodBehavior(null);
        setSelectedBadBehavior(null);
        
        // Force UI refresh
        setSelectedDate(new Date(selectedDate));
      };
      
      // Kid manager component
      const renderKidManager = () => {
        if (!showKidManager) return null;
        
        return (
          <div className="modal-backdrop">
            <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Kid Manager</h2>
                <button
                  onClick={() => setShowKidManager(false)}
                  className="text-2xl hover:text-gray-700">
                  Ã—
                </button>
              </div>
              
              {/* List of kids */}
              <div className="mb-4">
                {kids.length > 0 ? (
                  kids.map(kid => (
                    <div 
                      key={kid.id} 
                      className={`flex items-center justify-between p-3 my-2 ${kid.id === activeKidId ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50'} rounded-lg`}
                    >
                      <div className="flex items-center">
                        <span className="text-2xl mr-3">{kid.avatar}</span>
                        <div className="flex-1">
                          <div className="font-medium">{kid.name}</div>
                          <div className="text-sm text-gray-600">
                            {kidsData[kid.id]?.points || 0} stars earned
                          </div>
                        </div>
                      </div>
                      <div className="flex space-x-2">
                        <button 
                          onClick={() => {
                            const newName = prompt("Enter new name:", kid.name);
                            const newAvatar = prompt("Enter new avatar emoji:", kid.avatar);
                            if (newName && newName.trim() !== "") {
                              editKid(kid.id, { 
                                name: newName, 
                                avatar: newAvatar && newAvatar.trim() !== "" ? newAvatar : kid.avatar 
                              });
                            }
                          }}
                          className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                        >
                          Edit
                        </button>
                        {kid.id !== activeKidId && (
                          <button 
                            onClick={() => switchKid(kid.id)}
                            className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                          >
                            Select
                          </button>
                        )}
                        <button 
                          onClick={() => deleteKid(kid.id)}
                          className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-4 text-gray-500">
                    No children added yet
                  </div>
                )}
              </div>
              
              {/* Add new kid form */}
              {isAddingKid ? (
                <div className="p-4 border-2 border-dashed border-blue-300 rounded-lg">
                  <div className="flex mb-2 items-center">
                    <input
                      type="text"
                      placeholder="Avatar"
                      value={newKid.avatar}
                      onChange={e => setNewKid({ ...newKid, avatar: e.target.value })}
                      className="w-16 p-2 border rounded-lg mr-2 text-center text-xl"
                    />
                    <input
                      type="text"
                      placeholder="Child's name"
                      value={newKid.name}
                      onChange={e => setNewKid({ ...newKid, name: e.target.value })}
                      className="flex-1 p-2 border rounded-lg"
                    />
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={addKid}
                      className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg"
                    >
                      Add Child
                    </button>
                    <button
                      onClick={() => {
                        setNewKid({ name: "", avatar: "ðŸ‘¶" });
                        setIsAddingKid(false);
                      }}
                      className="flex-1 bg-gray-300 hover:bg-gray-400 py-2 rounded-lg"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              ) : (
                <button
                  onClick={() => setIsAddingKid(true)}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg"
                >
                  Add New Child
                </button>
              )}
            </div>
          </div>
        );
      };
      
      // Initialize p5.js or use CSS animation fallback
      React.useEffect(() => {
        // Skip p5.js initialization if the simple background is enabled
        if (useSimpleBackground) {
          const container = document.getElementById('p5-container');
          if (container) {
            container.style.display = 'none';
          }
          document.body.classList.add('simple-background');
          return;
        }
        
        try {
          // p5.js sketch for background animations - explicitly avoiding all sensor APIs
          new p5((p) => {
            // Explicitly disable device orientation and motion events
            p.deviceOrientation = undefined;
            p.deviceMoved = undefined;
            p.deviceTurned = undefined;
            p.deviceShaken = undefined;
            
            const particles = [];
            const colors = ['#4338ca', '#3b82f6', '#60a5fa', '#93c5fd'];
            let canvasWidth = window.innerWidth;
            let canvasHeight = window.innerHeight;

            p.setup = () => {
              p.createCanvas(canvasWidth, canvasHeight);
              initializeParticles();
              
              // Disable any orientation-related features
              if (p.setShakeThreshold) {
                p.setShakeThreshold(9999); // Effectively disable shake detection
              }
            };

            function initializeParticles() {
              particles.length = 0; // Clear existing particles
              for (let i = 0; i < 30; i++) {
                particles.push({
                  x: p.random(canvasWidth),
                  y: p.random(canvasHeight),
                  size: p.random(5, 15),
                  color: p.random(colors),
                  speedX: p.random(-0.5, 0.5),
                  speedY: p.random(-0.5, 0.5)
                });
              }
            }

            p.draw = () => {
              p.clear();

              particles.forEach(particle => {
                p.noStroke();
                p.fill(particle.color);
                p.ellipse(particle.x, particle.y, particle.size);

                particle.x += particle.speedX;
                particle.y += particle.speedY;

                if (particle.x < 0 || particle.x > canvasWidth) particle.speedX *= -1;
                if (particle.y < 0 || particle.y > canvasHeight) particle.speedY *= -1;
              });
            };

            p.windowResized = () => {
              canvasWidth = window.innerWidth;
              canvasHeight = window.innerHeight;
              p.resizeCanvas(canvasWidth, canvasHeight);
              initializeParticles();
            };
          }, 'p5-container');
        } catch (error) {
          console.error("P5.js initialization error:", error);
          // Log specific info if it's a sensor-related error
          if (error.message && (
            error.message.includes('orientation') || 
            error.message.includes('sensor') || 
            error.message.includes('permission')
          )) {
            console.info("This appears to be a sensor permission error. Disabling p5.js animations.");
          }
          
          // Gracefully handle p5.js failure - remove the container to prevent further errors
          const container = document.getElementById('p5-container');
          if (container) {
            container.style.display = 'none';
          }
          
          // Provide a simple fallback background if p5 fails
          document.body.style.background = 'linear-gradient(to right, #f0f4fd, #e6eefa)';
        }
      }, [useSimpleBackground]);

      // Force re-render on critical state changes
      React.useEffect(() => {
        console.log(`Critical state changed - Forcing refresh`);
        console.log(`Current kid: ${activeKid.name} (ID: ${activeKidId})`);
        
        // The selectedDate is updated to force a re-render
        const newDate = new Date(selectedDate);
        newDate.setMilliseconds(newDate.getMilliseconds() + Math.random() * 100);
        setSelectedDate(newDate);
        
        // Also increment render trigger to ensure components re-render
        setRenderTrigger(prev => prev + 1);
      }, [activeKidId, JSON.stringify(kidsData)]);
      
      // Save app state to localStorage whenever critical state changes
      React.useEffect(() => {
        // Only save if kids array is not empty
        if (kids.length > 0) {
          saveAppState(kids, activeKidId, kidsData);
        }
      }, [kids, activeKidId, kidsData]);
      
      // Additional UI refresh when behaviors or logs change
      React.useEffect(() => {
        if (activeKidId && kidsData[activeKidId]) {
          console.log(`Detected change in behaviors or logs - Refreshing UI`);
          
          // Increment render trigger
          setRenderTrigger(prev => prev + 1);
          
          // Force re-render
          const refreshDate = new Date(selectedDate);
          refreshDate.setMilliseconds(refreshDate.getMilliseconds() + Math.random() * 100);
          setSelectedDate(refreshDate);
        }
      }, [
        activeKidId, 
        // Use the actual behaviors and logs in dependencies, not stringify
        kidsData[activeKidId]?.behaviors, 
        kidsData[activeKidId]?.dailyBehaviorLogs,
        // Also watch points
        kidsData[activeKidId]?.points
      ]);

      // CRITICAL NEW EFFECT: Watch specific date behaviors to force UI update when they change
      React.useEffect(() => {
        if (activeKidId && kidsData[activeKidId]) {
          const dateKey = formatDateKey(selectedDate);
          const dateBehaviors = kidsData[activeKidId]?.behaviors?.[dateKey];
          const dateLogs = kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey];
          
          console.log(`Selected date ${dateKey} behaviors/logs changed - VERIFYING DATA`);
          console.log(`Current behaviors for date ${dateKey}:`, dateBehaviors);
          console.log(`Current logs for date ${dateKey}:`, dateLogs);
          
          // Verify date key is consistent
          if (selectedDate) {
            const formattedKey = formatDateKey(selectedDate);
            console.log(`Verifying date key formatting - Current selected date: ${selectedDate.toISOString()}`);
            console.log(`Formatted as key: ${formattedKey}`);
            
            // Force a re-render if data has changed
            setRenderTrigger(prev => prev + 1);
          }
        }
      }, [
        selectedDate, 
        activeKidId,
        // Watch only behaviors and logs for the selected date
        JSON.stringify(kidsData[activeKidId]?.behaviors?.[formatDateKey(selectedDate)] || {}),
        JSON.stringify(kidsData[activeKidId]?.dailyBehaviorLogs?.[formatDateKey(selectedDate)] || [])
      ]);

      // Force re-render when switching kids
      React.useEffect(() => {
        console.log(`Active kid changed to ${activeKid.name} (ID: ${activeKidId})`);
        // No need to do anything else - this dependency will trigger a re-render
      }, [activeKidId]);

      // Handle behavior recording with specific behavior selection
      const recordBehavior = () => {
        const dateKey = formatDateKey(selectedDate);
        
        console.log(`STARTING RECORD BEHAVIOR - Date: ${dateKey}, Kid: ${activeKid.name}(${activeKidId})`);
        
        // Get selected behavior
        const selectedBehavior = activeBehavior === 'good'
          ? goodBehaviors.find(b => b.id === selectedGoodBehavior)
          : badBehaviors.find(b => b.id === selectedBadBehavior);

        if (!selectedBehavior) {
          alert(`Please select a ${activeBehavior} behavior first`);
          return;
        }

        console.log(`Selected ${activeBehavior} behavior:`, selectedBehavior);
        
        // Get the most current kid data from state
        const currentKidData = {...kidsData[activeKidId]};
        console.log("Current kid data before update:", currentKidData);
        
        // Get current behaviors and logs for this date 
        const currentDayBehaviors = currentKidData.behaviors[dateKey] || { good: 0, bad: 0 };
        const currentDateLogs = currentKidData.dailyBehaviorLogs[dateKey] || [];
        
        console.log("Current day behaviors:", currentDayBehaviors);
        console.log("Current date logs:", currentDateLogs);
        
        // Create updated day behaviors
        const updatedDayBehaviors = {
          ...currentDayBehaviors,
          [activeBehavior]: (currentDayBehaviors[activeBehavior] || 0) + 1
        };
        
        // Create new log entry
        const newLog = {
          id: Date.now(),
          type: activeBehavior,
          behaviorId: selectedBehavior.id,
          description: selectedBehavior.description,
          points: selectedBehavior.points,
          icon: selectedBehavior.icon,
          timestamp: new Date().toLocaleTimeString()
        };
        
        // Calculate new points
        const newPoints = activeBehavior === 'good'
          ? currentKidData.points + selectedBehavior.points
          : Math.max(0, currentKidData.points - selectedBehavior.points);
        
        // Create a single updated kid data object
        const updatedKidData = {
          ...currentKidData,
          points: newPoints,
          behaviors: {
            ...currentKidData.behaviors,
            [dateKey]: updatedDayBehaviors
          },
          dailyBehaviorLogs: {
            ...currentKidData.dailyBehaviorLogs,
            [dateKey]: [...currentDateLogs, newLog]
          }
        };
        
        // Update all kid data in a single operation
        setKidsData(prevKidsData => ({
          ...prevKidsData,
          [activeKidId]: updatedKidData
        }));
        
        console.log("AFTER UPDATE - Full updated kid data:", updatedKidData);
        console.log(`AFTER UPDATE - Day behaviors for ${dateKey}:`, updatedKidData.behaviors[dateKey]);
        console.log(`AFTER UPDATE - Day logs for ${dateKey}:`, updatedKidData.dailyBehaviorLogs[dateKey]);
        
        // Handle confetti for good behaviors
        if (activeBehavior === 'good') {
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 3000);
        }

        // Reset behavior selection
        if (activeBehavior === 'good') {
          setSelectedGoodBehavior(null);
        } else {
          setSelectedBadBehavior(null);
        }
        
        // Force UI refresh with render trigger (keep this to ensure UI updates)
        setRenderTrigger(prev => prev + 1);
        
        // Force another UI refresh after a delay to ensure changes are visible
        setTimeout(() => {
          console.log("VERIFYING UPDATE - Current kid data after delay:", kidsData[activeKidId]);
          console.log(`VERIFYING UPDATE - Day behaviors after delay:`, kidsData[activeKidId]?.behaviors?.[dateKey]);
          console.log(`VERIFYING UPDATE - Day logs after delay:`, kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey]);
          setRenderTrigger(prev => prev + 1);
        }, 100);
      };

      // Add a new behavior
      const addBehavior = () => {
        if (newBehavior.description && newBehavior.points > 0) {
          if (behaviorTypeToAdd === 'good') {
            const newId = Math.max(0, ...goodBehaviors.map(b => b.id)) + 1;
            setGoodBehaviors([...goodBehaviors, { ...newBehavior, id: newId }]);
          } else {
            const newId = Math.max(0, ...badBehaviors.map(b => b.id)) + 1;
            setBadBehaviors([...badBehaviors, { ...newBehavior, id: newId }]);
          }

          setNewBehavior({ description: "", points: 1, icon: "â­" });
          setIsAddingBehavior(false);
        }
      };

      // Delete a behavior
      const deleteBehavior = (id, type) => {
        if (type === 'good') {
          setGoodBehaviors(goodBehaviors.filter(b => b.id !== id));
          if (selectedGoodBehavior === id) setSelectedGoodBehavior(null);
        } else {
          setBadBehaviors(badBehaviors.filter(b => b.id !== id));
          if (selectedBadBehavior === id) setSelectedBadBehavior(null);
        }
      };

      // Claim a reward
      const claimReward = (id) => {
        const reward = rewards.find(r => r.id === id);

        if (reward && currentPoints >= reward.points) {
          setRewards(rewards.map(r =>
            r.id === id ? { ...r, claimed: true } : r
          ));
          setCurrentPoints(prev => prev - reward.points);
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 3000);
        }
      };

      // Add a new reward
      const addReward = () => {
        if (newReward.name && newReward.points > 0) {
          const newId = Math.max(0, ...rewards.map(r => r.id)) + 1;
          setRewards([...rewards, { ...newReward, id: newId, claimed: false }]);
          setNewReward({ name: "", points: 0, icon: "ðŸŽ" });
          setIsAddingReward(false);
        }
      };

      // Reset a claimed reward
      const resetReward = (id) => {
        setRewards(rewards.map(r =>
          r.id === id ? { ...r, claimed: false } : r
        ));
      };

      // Generate the calendar grid
      const renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDayOfMonth = getFirstDayOfMonth(year, month);

        const days = [];

        // Get the most current kid data directly from state
        const currentKidData = kidsData[activeKidId] || {};
        const currentBehaviors = currentKidData.behaviors || {};
        
        console.log(`CALENDAR RENDER - kid:${activeKid.name}(${activeKidId}), month:${month}, year:${year}`);
        console.log(`CALENDAR RENDER - current behaviors:`, currentBehaviors);

        // Add empty cells for the days before the first day of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
          days.push(<div key={`empty-${i}-${activeKidId}-${month}-${renderTrigger}`} className="h-12 md:h-16"></div>);
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dateKey = formatDateKey(date);
          
          // Get day behaviors directly from current state
          const dayBehaviors = currentBehaviors[dateKey] || { good: 0, bad: 0 };

          // Log when behaviors exist for a day
          if (dayBehaviors.good > 0 || dayBehaviors.bad > 0) {
            console.log(`CALENDAR RENDER - Day ${day} behaviors:`, dayBehaviors);
          }

          const isSelected =
            selectedDate.getDate() === day &&
            selectedDate.getMonth() === month &&
            selectedDate.getFullYear() === year;

          // Include renderTrigger in the key to force re-render when it changes
          days.push(
            <div 
              key={`${activeKidId}-day-${day}-${month}-${renderTrigger}-g${dayBehaviors.good}-b${dayBehaviors.bad}`} 
              className={`calendar-day h-12 md:h-16 border rounded-lg flex flex-col items-center justify-center cursor-pointer ${isSelected ? 'bg-blue-200 border-blue-500' :
                dayBehaviors.good > dayBehaviors.bad ? 'bg-green-100' :
                  dayBehaviors.bad > 0 ? 'bg-red-100' : 'bg-white'
              }`}
              onClick={() => setSelectedDate(date)}
            >
              <div className="font-bold text-lg">{day}</div>
              {dayBehaviors.good > 0 && (
                <div className="flex items-center">
                  <span className="text-green-500 text-xs">+{dayBehaviors.good}</span>
                </div>
              )}
              {dayBehaviors.bad > 0 && (
                <div className="flex items-center">
                  <span className="text-red-500 text-xs">-{dayBehaviors.bad}</span>
                </div>
              )}
            </div>
          );
        }

        return days;
      };

      // Format the month name
      const formatMonth = (date) => {
        return date.toLocaleString('default', { month: 'long', year: 'numeric' });
      };

      // Navigate to previous or next month
      const changeMonth = (increment) => {
        const newDate = new Date(currentDate);
        newDate.setMonth(newDate.getMonth() + increment);
        setCurrentDate(newDate);
      };

      // Render daily behavior logs
      const renderDailyLogs = () => {
        const dateKey = formatDateKey(selectedDate);
        
        // Get the most current kid data directly from state
        const currentKidData = kidsData[activeKidId] || {};
        const currentLogs = currentKidData.dailyBehaviorLogs || {};
        const logs = currentLogs[dateKey] || [];
        
        console.log(`LOGS RENDER - kid:${activeKid.name}(${activeKidId}), date:${dateKey}, logs found:${logs.length}`);
        if (logs.length > 0) {
          console.log(`LOGS RENDER - Actual logs data:`, logs);
        }

        if (logs.length === 0) {
          return (
            <div className="text-gray-500 text-center py-4">
              No behaviors recorded for this day
            </div>
          );
        }

        return (
          <div className="max-h-60 overflow-y-auto mt-4">
            {
              logs.map((log) => (
                <div 
                  key={`${activeKidId}-log-${log.id}-${renderTrigger}`} 
                  className={`flex items-center p-2 my-1 rounded-lg ${log.type === 'good' ? 'bg-green-50' : 'bg-red-50'
                  }`}
                >
                  <span className="text-xl mr-2"> {log.icon} </span>
                  <div className="flex-1">
                    <div className="font-medium"> {log.description} </div>
                    <div className="text-xs text-gray-500"> {log.timestamp} </div>
                  </div>
                  <div className={`font-bold ${log.type === 'good' ? 'text-green-600' : 'text-red-600'
                    }`
                  }>
                    {log.type === 'good' ? '+' : '-'}{log.points}
                  </div>
                  {/* Delete button */}
                  <button 
                    onClick={() => removeBehavior(log.id)}
                    className="ml-2 text-gray-400 hover:text-red-500 transition-colors"
                    title="Remove behavior"
                  >
                    ðŸ—‘ï¸
                  </button>
                </div>
              ))
            }
          </div>
        );
      };

      // Render Icon Picker Modal
      const renderIconPicker = () => {
        if (!showIconPicker) return null;
        
        return (
          <div className="relative">
            <div 
              className="emoji-popup p-3"
              onClick={(e) => e.stopPropagation()} 
              ref={iconPickerRef}
            >
              <div className="flex justify-between items-center mb-2">
                <h2 className="text-sm font-bold">Select an Icon</h2>
                <button
                  onClick={() => setShowIconPicker(false)}
                  className="text-lg hover:text-gray-700">
                  Ã—
                </button>
              </div>
              
              {/* Search input */}
              <input
                type="text"
                placeholder="Search emojis..."
                value={emojiSearchTerm}
                onChange={(e) => setEmojiSearchTerm(e.target.value)}
                className="emoji-search"
              />
              
              {/* Category tabs */}
              {!emojiSearchTerm && (
                <div className="flex flex-wrap gap-1 mb-2">
                  {iconCategories.map((category, index) => (
                    <button
                      key={index}
                      className="px-2 py-0.5 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs"
                      onClick={() => {
                        // Scroll to category
                        document.getElementById(`icon-category-${index}`).scrollIntoView({ behavior: 'smooth' });
                      }}
                    >
                      {category.name}
                    </button>
                  ))}
                </div>
              )}
              
              {/* Icons by category */}
              <div className="icon-categories max-h-60 overflow-y-auto">
                {(emojiSearchTerm ? filteredCategories : iconCategories).map((category, categoryIndex) => (
                  category.icons.length > 0 ? (
                    <div key={categoryIndex} id={`icon-category-${categoryIndex}`} className="mb-3">
                      <h3 className="emoji-category-header">
                        {category.name}
                      </h3>
                      <div className="emoji-grid">
                        {category.icons.map((icon, iconIndex) => (
                          <button
                            key={`${categoryIndex}-${iconIndex}`}
                            className="emoji-item"
                            onClick={() => {
                              setNewBehavior({...newBehavior, icon: icon});
                              setShowIconPicker(false);
                              setEmojiSearchTerm('');
                            }}
                            title={`Select ${icon}`}
                          >
                            {icon}
                          </button>
                        ))}
                      </div>
                    </div>
                  ) : null
                ))}
                
                {/* No results message */}
                {emojiSearchTerm && filteredCategories.length === 0 && (
                  <div className="text-center py-4 text-gray-500">
                    No emojis found for "{emojiSearchTerm}"
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Render behavior manager modal (modified version with icon picker)
      const renderBehaviorManager = () => {
        if (!showBehaviorManager) return null;

        return (
          <div className="modal-backdrop">
            <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold"> Behavior Manager </h2>
                <button
                  onClick={() => setShowBehaviorManager(false)}
                  className="text-2xl hover:text-gray-700">
                  Ã—
                </button>
              </div>

              {/* Tabs for switching between good and bad behaviors */}
              <div className="flex mb-4">
                <button 
                        className={
                  `flex-1 py-2 rounded-tl-lg rounded-bl-lg font-medium ${behaviorTypeToAdd === 'good'
                    ? 'bg-green-500 text-white'
                    : 'bg-gray-200'
                  }`
                }
                onClick={() => setBehaviorTypeToAdd('good')}
                >
                  Good Behaviors
                </button>
                <button
                  className={`flex-1 py-2 rounded-tr-lg rounded-br-lg font-medium ${behaviorTypeToAdd === 'bad'
                    ? 'bg-red-500 text-white'
                    : 'bg-gray-200'
                  }`}
                  onClick={() => setBehaviorTypeToAdd('bad')}
                >
                  Needs Improvement
                </button>
              </div>

              {/* List of behaviors */}
              <div className="mb-4">
                {behaviorTypeToAdd === 'good' ? (
                  goodBehaviors.length > 0 ? (
                    goodBehaviors.map(behavior => (
                      <div 
                                key={behavior.id} 
                                className="behavior-card flex items-center justify-between p-3 my-2 bg-green-50 rounded-lg"
                      >
                        <div className="flex items-center">
                          <span className="text-2xl mr-3"> {behavior.icon} </span>
                          <div>
                            <div className="font-medium"> {behavior.description} </div>
                            <div className="text-sm text-green-600"> +{behavior.points} stars </div>
                          </div>
                        </div>
                        <button 
                                  onClick={() => deleteBehavior(behavior.id, 'good')}
                          className="text-red-500 hover:text-red-700 text-lg">
                                  ðŸ—‘ï¸
                        </button>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-4 text-gray-500">
                      No good behaviors added yet
                    </div>
                  )
                ) : (
                  badBehaviors.length > 0 ? (
                    badBehaviors.map(behavior => (
                      <div 
                                key={behavior.id} 
                                className="behavior-card flex items-center justify-between p-3 my-2 bg-red-50 rounded-lg"
                      >
                        <div className="flex items-center">
                          <span className="text-2xl mr-3"> {behavior.icon} </span>
                          <div>
                            <div className="font-medium"> {behavior.description} </div>
                            <div className="text-sm text-red-600"> -{behavior.points} stars </div>
                          </div>
                        </div>
                        <button 
                                  onClick={() => deleteBehavior(behavior.id, 'bad')}
                          className="text-red-500 hover:text-red-700 text-lg">
                                  ðŸ—‘ï¸
                        </button>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-4 text-gray-500">
                      No behaviors that need improvement added yet
                    </div>
                  )
                )}
              </div>

              {/* Add new behavior form - updated with icon picker button */}
              {
                isAddingBehavior ? (
                  <div className="p-4 border-2 border-dashed border-blue-300 rounded-lg">
                    <div className="flex mb-2 items-center">
                      <div className="relative mr-2">
                        <div 
                          className="w-16 p-2 border rounded-lg text-center text-xl cursor-pointer flex justify-center items-center hover:bg-gray-50"
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowIconPicker(true);
                          }}
                        >
                          {newBehavior.icon || "â­"}
                        </div>
                        <div className="absolute -right-1 -bottom-1 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer hover:bg-blue-600" onClick={(e) => {
                          e.stopPropagation();
                          setShowIconPicker(true);
                        }}>
                          +
                        </div>
                        {renderIconPicker()}
                      </div>
                      <input
                        type="text"
                        placeholder="Behavior description"
                        value={newBehavior.description}
                        onChange={e => setNewBehavior({ ...newBehavior, description: e.target.value })}
                        className="flex-1 p-2 border rounded-lg"
                      />
                    </div>
                    <div className="flex mb-2 items-center">
                      <span className="mr-2"> Stars: </span>
                        <input
                          type="number"
                          min="1"
                          max="10"
                          value={newBehavior.points}
                          onChange={e => setNewBehavior({ ...newBehavior, points: parseInt(e.target.value) || 1})}
                          className="flex-1 p-2 border rounded-lg"
                        />
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={addBehavior}
                        className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
                        Add
                      </button>
                      <button
                        onClick={() => {
                          setNewBehavior({ description: "", points: 1, icon: "â­" });
                          setIsAddingBehavior(false);
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 py-2 rounded-lg">
                        Cancel
                      </button>
                    </div>
                  </div>
                ) : (
                  <button
                        onClick={() => setIsAddingBehavior(true)}
                        className="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                        Add New {behaviorTypeToAdd === 'good' ? 'Good' : 'Needs Improvement'} Behavior
                  </button>
                )
              }
            </div>
          </div>
        );
      };

      // Render the app
      return (
        <div className="container mx-auto p-4 relative">
          {/* Header */}
          <div className="text-center mb-6">
            <h1 className="app-title text-4xl md:text-5xl mb-2"> Star Behavior Tracker </h1>
            <div className="flex justify-center items-center mb-4">
              <div className="flex items-center">
                <span className="text-2xl mr-2">{activeKid.avatar}</span>
                <div 
                  className="bg-white border border-purple-300 rounded-lg px-3 py-2 text-center text-xl font-bold outline-none focus:border-purple-500 cursor-pointer"
                  onClick={() => setShowKidManager(true)}
                >
                  {activeKid.name}
                </div>
                <button 
                  onClick={() => setShowKidManager(true)}
                  className="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded-lg text-sm"
                  title="Manage children"
                >
                  Manage Kids
                </button>
              </div>
            </div>
            <div className="bg-gradient-to-r from-purple-600 to-blue-500 text-white py-2 px-4 rounded-full inline-flex items-center">
              <span className="mr-2"> Total Stars: </span>
                <span className="font-bold text-xl"> {currentPoints} â­</span>
            </div>
          </div>

          {/* Main Content */}
          <div className="md:flex gap-6">
            {/* Calendar Section */}
            <div className="md:w-3/5 bg-white p-4 rounded-xl shadow-lg mb-6 md:mb-0">
              <div className="flex justify-between items-center mb-4">
                <button 
                        onClick={() => changeMonth(-1)}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                          &larr;
                </button>
                <h2 className="text-2xl font-bold text-center"> {formatMonth(currentDate)} </h2>
                <button
                  onClick={() => changeMonth(1)}
                  className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                          &rarr;
                </button>
              </div>

              {/* Day names */}
              <div className="grid grid-cols-7 gap-2 mb-2">
                {
                  ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                    <div key={day} className="text-center font-bold"> {day} </div>
                  ))
                }
              </div>

              {/* Calendar grid - Use renderTrigger in key */}
              <div 
                className="grid grid-cols-7 gap-2" 
                key={`calendar-grid-${activeKidId}-${currentDate.getMonth()}-${currentDate.getFullYear()}-${renderTrigger}`}
              >
                {renderCalendar()}
              </div>

              {/* Selected date behavior */}
              <div className="mt-6 bg-blue-50 p-4 rounded-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-xl font-bold">
                    {
                      selectedDate.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric'
                      })
                    }
                  </h3>

                  <button
                    onClick={() => setShowBehaviorManager(true)}
                    className="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-lg text-sm">
                    Manage Behaviors
                  </button>
                </div>

                <div className="flex space-x-4 mt-4">
                  <button 
                    className={
                      `flex-1 py-3 rounded-lg font-bold flex items-center justify-center ${activeBehavior === 'good'
                        ? 'bg-green-500 text-white'
                        : 'bg-green-100 text-green-700'
                      }`
                    }
                    onClick={() => {
                      setActiveBehavior('good');
                      setSelectedBadBehavior(null); // Reset bad behavior selection when switching
                    }}
                  >
                    Good Behavior ðŸ˜Š
                  </button>
                  <button
                    className={`flex-1 py-3 rounded-lg font-bold flex items-center justify-center ${activeBehavior === 'bad'
                      ? 'bg-red-500 text-white'
                      : 'bg-red-100 text-red-700'
                    }`}
                    onClick={() => {
                      setActiveBehavior('bad');
                      setSelectedGoodBehavior(null); // Reset good behavior selection when switching
                    }}
                  >
                    Needs Improvement ðŸ˜Ÿ
                  </button>
                </div>

                {/* Behavior selection */}
                <div className="mt-4">
                  <div className="text-sm font-bold mb-2">
                    Select behavior:
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {activeBehavior === 'good' ? (
                      goodBehaviors.length > 0 ? (
                        goodBehaviors.map(behavior => (
                          <div 
                            key={behavior.id} 
                            className={`behavior-tag px-3 py-2 rounded-lg cursor-pointer flex items-center ${selectedGoodBehavior === behavior.id
                              ? 'bg-green-500 text-white'
                              : 'bg-green-100 text-green-700'
                            }`}
                            onClick={() => setSelectedGoodBehavior(behavior.id)}
                          >
                            <span className="mr-2"> {behavior.icon} </span>
                            <span> {behavior.description} </span>
                            <span className="ml-2 bg-green-200 text-green-800 px-1 rounded"> +{behavior.points} </span>
                          </div>
                        ))
                      ) : (
                        <div className="text-gray-500 italic">
                          No good behaviors added yet. Use the Manage Behaviors button to add some.
                        </div>
                      )
                    ) : (
                      badBehaviors.length > 0 ? (
                        badBehaviors.map(behavior => (
                          <div 
                            key={behavior.id} 
                            className={`behavior-tag px-3 py-2 rounded-lg cursor-pointer flex items-center ${selectedBadBehavior === behavior.id
                              ? 'bg-red-500 text-white'
                              : 'bg-red-100 text-red-700'
                            }`}
                            onClick={() => setSelectedBadBehavior(behavior.id)}
                          >
                            <span className="mr-2"> {behavior.icon} </span>
                            <span> {behavior.description} </span>
                            <span className="ml-2 bg-red-200 text-red-800 px-1 rounded"> -{behavior.points} </span>
                          </div>
                        ))
                      ) : (
                        <div className="text-gray-500 italic">
                          No behaviors that need improvement added yet. Use the Manage Behaviors button to add some.
                        </div>
                      )
                    )}
                  </div>
                </div>

                <button
                  onClick={recordBehavior}
                  className={`w-full mt-4 py-3 rounded-lg font-bold ${activeBehavior === 'good'
                      ? 'bg-green-500 hover:bg-green-600 text-white'
                      : 'bg-red-500 hover:bg-red-600 text-white'
                    }`}
                >
                  {activeBehavior === 'good'
                    ? 'Record Good Behavior'
                    : 'Record Needs Improvement'}
                </button>

                {/* Daily logs - Use renderTrigger in key */}
                <div className="mt-4">
                  <h3 className="text-lg font-bold mb-2"> Today's Behaviors:</h3>
                  <div 
                    key={`daily-logs-${activeKidId}-${formatDateKey(selectedDate)}-${renderTrigger}`}
                  >
                    {renderDailyLogs()}
                  </div>
                </div>
              </div>
            </div>

            {/* Rewards Section */}
            <div className="md:w-2/5 bg-white p-4 rounded-xl shadow-lg">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold"> Rewards </h2>
                <button
                  onClick={() => setIsAddingReward(!isAddingReward)}
                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg">
                  {isAddingReward ? 'Cancel' : 'Add Reward'}
                </button>
              </div>

              {/* Add new reward form */}
              {
                isAddingReward && (
                  <div className="mb-4 p-3 border-2 border-dashed border-blue-300 rounded-lg">
                    <div className="flex mb-2 items-center">
                      <input
                                type="text"
                        placeholder="Icon"
                        value={newReward.icon}
                        onChange={e => setNewReward({ ...newReward, icon: e.target.value })}
                        className="w-16 p-2 border rounded-lg mr-2 text-center text-xl"
                      />
                      <input
                                type="text"
                        placeholder="Reward name"
                        value={newReward.name}
                        onChange={e => setNewReward({ ...newReward, name: e.target.value })}
                        className="flex-1 p-2 border rounded-lg"
                      />
                    </div>
                    <div className="flex mb-2 items-center">
                      <span className="mr-2"> Stars needed: </span>
                        <input
                          type="number"
                          min="1"
                          value={newReward.points}
                          onChange={e => setNewReward({ ...newReward, points: parseInt(e.target.value) || 0})}
                          className="flex-1 p-2 border rounded-lg"
                        />
                    </div>
                    <button
                      onClick={addReward}
                      className="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
                      Add Reward
                    </button>
                  </div>
                )
              }

              {/* Rewards list */}
              <div className="grid grid-cols-1 gap-4">
                {
                  rewards.map(reward => (
                    <div 
                            key={reward.id} 
                            className={`reward-card p-4 ${reward.claimed
                        ? 'bg-gray-100'
                        : 'bg-blue-50'
                      } rounded-lg shadow-sm`}
                    >
                      <div className="flex items-center mb-2">
                        <span className="text-3xl mr-3"> {reward.icon} </span>
                        <h3 className="font-bold text-lg flex-1"> {reward.name} </h3>
                        <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm font-bold">
                          {reward.points} â­
                        </span>
                      </div>

                      {
                        reward.claimed ? (
                          <div className="flex space-x-2">
                            <div className="flex-1 bg-green-100 text-green-800 py-2 rounded-lg text-center font-bold">
                              Claimed!
                            </div>
                            <button
                              onClick={() => resetReward(reward.id)}
                              className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg">
                              Reset
                            </button>
                          </div>
                        ) : (
                          <button
                            onClick={() => claimReward(reward.id)}
                            className={`w-full py-2 rounded-lg font-bold ${currentPoints >= reward.points
                                ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white hover:opacity-90'
                                : 'bg-gray-200 text-gray-500 cursor-not-allowed'
                              }`}
                            disabled={currentPoints < reward.points}
                          >
                            {currentPoints >= reward.points
                              ? 'Claim Reward!'
                              : `Need ${reward.points - currentPoints} more stars`}
                          </button>
                        )
                      }
                    </div>
                  ))
                }

                {
                  rewards.length === 0 && (
                    <div className="text-center py-4 text-gray-500">
                      No rewards added yet
                    </div>
                  )
                }
              </div>
            </div>
          </div>

          {/* Kid management modal */}
          {renderKidManager()}

          {/* Behavior management modal */}
          {renderBehaviorManager()}

          {/* Confetti effect */}
          {
            showConfetti && (
              <div className="fixed inset-0 pointer-events-none z-50">
                {
                  Array.from({ length: 50 }).map((_, i) => (
                    <div
                            key={i}
                            className="absolute"
                            style={{
                            left: `${Math.random() * 100}%`,
                            top: '-20px',
                            width: `${Math.random() * 20 + 10}px`,
                            height: `${Math.random() * 20 + 10}px`,
                            backgroundColor: ['#FFD700', '#4338CA', '#3B82F6', '#EC4899'][Math.floor(Math.random() * 4)],
                            borderRadius: '50%',
                            animation: `fall ${Math.random() * 3 + 2}s linear forwards`,
                            animationDelay: `${Math.random() * 2}s`
                          }}
                    />
                  ))
                }
              </div>
            )
          }
          
          {/* Accessibility toggle for background animation */}
          <div className="fixed bottom-2 right-2 z-40">
            <button 
              onClick={() => setUseSimpleBackground(!useSimpleBackground)}
              className="text-xs bg-white/80 hover:bg-white/100 px-2 py-1 rounded-md shadow-sm text-gray-600"
              title={useSimpleBackground ? "Enable particle animations" : "Switch to simple background"}
            >
              {useSimpleBackground ? "ðŸŒŸ Enable particles" : "ðŸŽ¨ Simple background"}
            </button>
          </div>

        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
    </script>
  </body>
</html>

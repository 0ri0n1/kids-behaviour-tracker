<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Behavior Tracker</title>
    
    <!-- Favicon -->
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- Updated meta tag to prevent all sensor API warnings -->
    <meta http-equiv="Permissions-Policy" content="accelerometer=(), gyroscope=(), magnetometer=(), ambient-light-sensor=(), orientation-sensor=()">
    
    <!--
    PRODUCTION RECOMMENDATION: 
    For production, consider replacing these CDN links with bundled versions:
    1. Use a bundler like Webpack, Parcel, or Vite to compile React
    2. Use PostCSS to process Tailwind CSS and purge unused styles
    3. Pre-compile JSX instead of using in-browser Babel
    -->
    
    <!--React and React DOM-->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!--Babel for JSX (development only - should be precompiled for production)-->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!--p5.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    
    <!-- Add emoji-mart scripts -->
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@5.5.2/dist/browser.min.js"></script>
    
    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="assets/css/tailwind.css">
    
    <!-- CSS for fallback animation -->
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      
      /* Emoji picker styles */
      .emoji-popup {
        position: absolute;
        top: auto;
        left: 0;
        bottom: calc(100% + 8px);
        transform: translateY(0);
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        width: 360px;
        max-width: 90vw;
        max-height: 400px;
        overflow-y: scroll;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
        border: 1px solid #e2e8f0;
      }
      
      /* Hide scrollbar for Webkit browsers */
      .emoji-popup::-webkit-scrollbar {
        display: none;
      }
      
      /* Position emoji picker better on mobile */
      @media (max-width: 640px) {
        .emoji-popup {
          position: fixed;
          top: 50%;
          left: 50%;
          bottom: auto;
          transform: translate(-50%, -50%);
          width: 90%;
          max-height: 80vh;
        }
      }
      
      /* Style for emoji-mart integration */
      .emoji-mart-container {
        width: 100%;
        height: 350px;
        overflow: hidden;
      }
      
      .emoji-mart {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        width: 100% !important;
        border: none !important;
      }
      
      /* Hide scrollbars in emoji-mart */
      .emoji-mart ::-webkit-scrollbar {
        display: none !important;
      }
      
      .emoji-mart * {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }
      
      .simple-emoji-picker {
        width: 100%;
        border-radius: 6px;
        background-color: #fff;
      }
      
      .emoji-category-header {
        font-size: 14px;
        padding: 6px 8px;
        font-weight: bold;
        color: #666;
        border-bottom: 1px solid #eee;
        margin-top: 8px;
      }
      
      .simple-background {
        background: linear-gradient(-45deg, #4338ca, #3b82f6, #60a5fa, #93c5fd);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }
      
      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      
      @keyframes fall {
        0% {
          transform: translateY(-10px) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
      
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        padding: 1rem;
      }

      /* Improved grid layout for emoji picker */
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
      }

      .emoji-item {
        height: 30px;
        width: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.1s ease;
      }

      .emoji-item:hover {
        background-color: #e0f2fe;
        transform: scale(1.1);
      }

      .emoji-search {
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin-bottom: 8px;
        width: 100%;
      }

      .emoji-category-header {
        font-weight: bold;
        font-size: 12px;
        margin: 8px 0 4px 0;
        padding-bottom: 4px;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 1;
      }
      
      /* Hide scrollbars universally */
      .no-scrollbar {
        overflow-y: scroll;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }
      
      .no-scrollbar::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }
    </style>
    
    <!-- Fallback for script loading errors -->
    <script>
      window.addEventListener('error', function(e) {
        // Check if the error is related to script loading
        if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
          console.warn('Resource failed to load:', e.target.src || e.target.href);
          
          // For babel sourcemap errors, prevent further logging
          if ((e.target.src || '').includes('babel') && (e.message || '').includes('source map')) {
            console.warn('Suppressing babel source map errors');
            e.preventDefault();
          }
        }
      }, true);
    </script>
    
    <!-- Emoji-mart initialization -->
    <script>
      // Initialize and store emoji-mart from CDN
      window.addEventListener('DOMContentLoaded', () => {
        console.log('Checking for emoji-mart availability...');
        setTimeout(() => {
          if (window.EmojiMart) {
            console.log('emoji-mart available from CDN as EmojiMart');
          } else if (window.emojiMart) {
            console.log('emoji-mart available from CDN as emojiMart');
          } else {
            console.log('emoji-mart not available from CDN, will try require');
          }
        }, 1000);
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <div id="p5-container"></div>
    <div id="three-container"></div>

    <noscript>
      <div style="text-align: center; padding: 20px; font-family: Arial, sans-serif;">
        <h1>JavaScript Required</h1>
        <p>This application requires JavaScript to function. Please enable JavaScript in your browser settings.</p>
      </div>
    </noscript>
    
    <!-- Remove CDN imports and use local version of emoji-mart -->
    <script>
      // Load emoji-mart data from node_modules when the app is ready
      window.addEventListener('DOMContentLoaded', () => {
        // For Electron apps, we can require node modules directly
        if (window.require) {
          try {
            // Try to load emoji-mart when running in Electron
            const emojiMartData = window.require('emoji-mart/data');
            window.emojiMartData = emojiMartData;
            console.log('Emoji-mart data loaded from node_modules');
          } catch (error) {
            console.error('Failed to load emoji-mart from node_modules:', error);
          }
        }
      });
    </script>
    
    <script type="text/babel" data-presets="react">
    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
      }
      
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      
      componentDidCatch(error, errorInfo) {
        console.error("React Error:", error, errorInfo);
        this.setState({ error, errorInfo });
      }
      
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: '20px', margin: '20px', border: '2px solid red', borderRadius: '5px', backgroundColor: '#fff8f8' }}>
              <h2>Something went wrong</h2>
              <details style={{ whiteSpace: 'pre-wrap', margin: '10px 0' }}>
                <summary>Show Error Details</summary>
                <p>{this.state.error && this.state.error.toString()}</p>
                <p>Component Stack: {this.state.errorInfo && this.state.errorInfo.componentStack}</p>
              </details>
              <button 
                onClick={() => window.location.reload()}
                style={{ padding: '8px 16px', backgroundColor: '#007bff', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
              >
                Reload Page
              </button>
            </div>
          );
        }
        
        return this.props.children;
      }
    }
    
    // Main App Component
    function App() {
      // Helper functions for date operations
      const formatDateKey = (date) => {
        // Ensure consistent formatting with padding for single-digit month/day
        const year = date.getFullYear();
        const month = String(date.getMonth()).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
      
      const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
      
      // Function to load behaviors from localStorage
      function loadBehaviors() {
        const behaviors = localStorage.getItem('behaviors');
        return behaviors ? JSON.parse(behaviors) : [];
      }
      
      // Function to save app state to localStorage
      function saveAppState(kids, activeKidId, kidsData) {
        localStorage.setItem('kids', JSON.stringify(kids));
        localStorage.setItem('activeKidId', activeKidId.toString());
        localStorage.setItem('kidsData', JSON.stringify(kidsData));
        console.log('App state saved to localStorage');
      }
      
      // Function to load app state from localStorage
      function loadAppState() {
        const savedKids = localStorage.getItem('kids');
        const savedActiveKidId = localStorage.getItem('activeKidId');
        const savedKidsData = localStorage.getItem('kidsData');
        
        if (savedKids && savedKidsData) {
          return {
            kids: JSON.parse(savedKids),
            activeKidId: parseInt(savedActiveKidId || '1', 10),
            kidsData: JSON.parse(savedKidsData)
          };
        }
        
        return null;
      }

      // Load saved state or use defaults
      const savedState = loadAppState();
      
      // Add state for first-time setup
      const [showSetupWizard, setShowSetupWizard] = React.useState(!savedState);
      const [setupStep, setSetupStep] = React.useState(1);
      
      // Add state for setup child data
      const [setupChild, setSetupChild] = React.useState({ name: "", avatar: "👶" });
      
      // Children management
      const [kids, setKids] = React.useState(savedState?.kids || [{ id: 1, name: "My Kid", avatar: "👧" }]);
      const [activeKidId, setActiveKidId] = React.useState(savedState?.activeKidId || 1);
      const [showKidManager, setShowKidManager] = React.useState(false);
      const [newKid, setNewKid] = React.useState({ name: "", avatar: "👶" });
      const [isAddingKid, setIsAddingKid] = React.useState(false);
      
      // Individual kid data
      const [kidsData, setKidsData] = React.useState(savedState?.kidsData || {
        1: {
          points: 0,
          behaviors: {},
          dailyBehaviorLogs: {},
          goodBehaviors: [
            { id: 1, description: "Cleaning up toys", points: 2, icon: "🧹" },
            { id: 2, description: "Helping a sibling", points: 3, icon: "🤝" },
            { id: 3, description: "Completing homework", points: 2, icon: "📚" },
            { id: 4, description: "Brushing teeth without reminder", points: 1, icon: "🪥" },
            { id: 5, description: "Setting the table", points: 1, icon: "🍽️" }
          ],
          badBehaviors: [
            { id: 1, description: "Not listening", points: 1, icon: "👂" },
            { id: 2, description: "Fighting with siblings", points: 2, icon: "😠" },
            { id: 3, description: "Not finishing food", points: 1, icon: "🍽️" },
            { id: 4, description: "Screen time without permission", points: 2, icon: "📱" },
            { id: 5, description: "Bedtime tantrum", points: 3, icon: "😭" }
          ],
          rewards: [
            { id: 1, name: "Playground Time", points: 20, claimed: false, icon: "🛝" },
            { id: 2, name: "Ice Cream", points: 30, claimed: false, icon: "🍦" },
            { id: 3, name: "Movie Night", points: 50, claimed: false, icon: "🎬" },
            { id: 4, name: "New Toy", points: 100, claimed: false, icon: "🧸" }
          ]
        }
      });

      const [currentDate, setCurrentDate] = React.useState(new Date());
      const [selectedDate, setSelectedDate] = React.useState(new Date());
      const [newReward, setNewReward] = React.useState({ name: "", points: 0, icon: "🎁" });
      const [isAddingReward, setIsAddingReward] = React.useState(false);
      const [activeBehavior, setActiveBehavior] = React.useState("good");
      const [showConfetti, setShowConfetti] = React.useState(false);
      // Flag to disable p5.js if it causes issues
      const [useSimpleBackground, setUseSimpleBackground] = React.useState(false);

      // State for managing behaviors and other UI elements
      const [savedBehaviors, setSavedBehaviors] = React.useState(loadBehaviors() || []);
      const [showIconPicker, setShowIconPicker] = React.useState(false);
      const [newBehavior, setNewBehavior] = React.useState({
        name: '',
        icon: '',
        pointValue: 1,
        description: '',
        trackFrequency: false
      });
      const [isAddingBehavior, setIsAddingBehavior] = React.useState(false);
      
      // Add state for editing behaviors
      const [isEditingBehavior, setIsEditingBehavior] = React.useState(false);
      const [behaviorToEdit, setBehaviorToEdit] = React.useState(null);
      
      // Add state for behavior type selection
      const [behaviorTypeToAdd, setBehaviorTypeToAdd] = React.useState("good");
      
      // Reference for the icon picker element
      const iconPickerRef = React.useRef(null);
      
      // Initialize emoji-mart data
      React.useEffect(() => {
        // For Electron apps, we can use the require function
        if (window.require) {
          try {
            // First check if emoji-mart is already loaded
            if (!window.emojiMartPicker || !window.emojiMartData) {
              console.log('Loading emoji-mart components...');
              
              // Try to load emoji-mart from node_modules
              try {
                // Load the Picker component
                const emojiMart = window.require('emoji-mart');
                window.emojiMartPicker = emojiMart.Picker;
                
                // Load the data
                const emojiData = window.require('@emoji-mart/data');
                window.emojiMartData = emojiData;
                
                console.log('Emoji components loaded successfully');
              } catch (err) {
                // Try loading with @emoji-mart/react if direct import fails
                try {
                  const emojiMartReact = window.require('@emoji-mart/react');
                  window.emojiMartPicker = emojiMartReact.Picker;
                  
                  const emojiData = window.require('@emoji-mart/data');
                  window.emojiMartData = emojiData;
                  
                  console.log('Emoji components loaded from @emoji-mart/react');
                } catch (innerErr) {
                  console.error('Failed to load emoji-mart components:', innerErr);
                }
              }
            }
          } catch (error) {
            console.error('Error loading emoji components:', error);
          }
        } else {
          console.log('window.require not available - in browser mode');
        }
      }, []);
      
      // Add event listener to close emoji picker when clicking outside
      React.useEffect(() => {
        function handleClickOutside(event) {
          if (showIconPicker && iconPickerRef.current && !iconPickerRef.current.contains(event.target)) {
            setShowIconPicker(false);
          }
        }
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => {
          document.removeEventListener('mousedown', handleClickOutside);
        };
      }, [showIconPicker]);
      
      // Track currently selected behaviors
      const [selectedGoodBehavior, setSelectedGoodBehavior] = React.useState(null);
      const [selectedBadBehavior, setSelectedBadBehavior] = React.useState(null);

      // Show/hide behavior lists
      const [showBehaviorManager, setShowBehaviorManager] = React.useState(false);

      // Add state to force re-renders
      const [renderTrigger, setRenderTrigger] = React.useState(0);

      // Add state for icon picker
      const [iconCategories, setIconCategories] = React.useState([
        {
          name: "Faces",
          icons: ["😊", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😍", "🥰", "😘", "😗", "😙", "😚", "😋", "😛", "😜", "😝", "🤑", "🤗", "🤔", "🤐", "😐", "😑", "😶", "😏", "😒", "🙄", "😬", "🤥", "😌", "😔", "😪", "🤤", "😴", "😷", "🤒", "🤕", "🤢", "🤮", "🤧", "😵", "🤯", "🥳", "😎", "🧐", "😕", "😟", "🙁", "☹️", "😮", "😯", "😲", "😳", "🥺", "😦", "😧", "😨", "😰", "😥", "😢", "😭", "😱", "😖", "😣", "😞", "😓", "😩", "😫", "🥱", "😤", "😡", "😠", "🤬", "😈", "👿", "💀", "☠️", "💩", "🤡", "👹", "👺", "👻", "👽", "👾", "🤖"]
        },
        {
          name: "Animals",
          icons: ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯", "🦁", "🐮", "🐷", "🐸", "🐵", "🐔", "🐧", "🐦", "🐤", "🐣", "🐥", "🦆", "🦅", "🦉", "🦇", "🐺", "🐗", "🐴", "🦄", "🐝", "🐛", "🦋", "🐌", "🐞", "🐜", "🦟", "🦗", "🕷", "🕸", "🦂", "🐢", "🐍", "🦎", "🦖", "🦕", "🐙", "🦑", "🦐", "🦞", "🦀", "🐡", "🐠", "🐟", "🐬", "🐳", "🐋", "🦈", "🐊", "🐅", "🐆", "🦓", "🦍", "🦧", "🐘", "🦛", "🦏", "🐪", "🐫", "🦒", "🦘", "🐃", "🐂", "🐄", "🐎", "🐖", "🐏", "🐑", "🦙", "🐐", "🦌", "🐕", "🐩", "🦮", "🐕‍🦺", "🐈", "🐓", "🦃", "🦚", "🦜", "🦢", "🦩", "🕊", "🐇", "🦝", "🦨", "🦡", "🦦", "🦥", "🐁", "🐀", "🐿", "🦔"]
        },
        {
          name: "Objects",
          icons: ["⭐", "🌟", "✨", "💫", "🪄", "🔮", "🎮", "🎲", "🧸", "🪅", "🪆", "🧩", "🎨", "🧵", "🧶", "🎭", "🎰", "🎪", "🎪", "🎭", "🎨", "🧵", "🧶", "🎮", "🎲", "🧩", "🧸", "📱", "📲", "💻", "⌨️", "🖥", "🖨", "🖱", "🖲", "🕹", "🗜", "💽", "💾", "💿", "📀", "📼", "📷", "📸", "📹", "🎥", "📽", "🎞", "📞", "☎️", "📟", "📠", "📺", "📻", "🎙", "🎚", "🎛", "🧭", "⏱", "⏲", "⏰", "🕰", "⌛", "⏳", "📡", "🔋", "🔌", "💡", "🔦", "🕯", "🪔", "🧯", "🛢", "💸", "💵", "💴", "💶", "💷", "💰", "💳", "💎", "⚖️", "🧰", "🔧", "🔨", "⚒", "🛠", "⛏", "🔩", "⚙️", "🧱", "⛓", "🧲", "🔫", "💣", "🧨", "🪓", "🔪", "🗡", "⚔️", "🛡", "🚬", "⚰️", "⚱️", "🏺", "🔮", "📿", "🧿", "💈", "⚗️", "🔭", "🔬", "🕳", "🩹", "🩺", "💊", "💉", "🩸", "🧬", "🦠", "🧫", "🧪", "🌡", "🧹", "🧺", "🧻", "🚽", "🚰", "🚿", "🛁", "🛀", "🧼", "🪒", "🧽", "🧴", "🛎", "🔑", "🗝", "🚪", "🪑", "🛋", "🛏", "🛌", "🧸", "🖼", "🛍", "🛒", "🎁", "🎈", "🎏", "🎀", "🎊", "🎉", "🎎", "🏮", "🎐", "🧧", "✉️", "📩", "📨", "📧", "💌", "📥", "📤", "📦", "🏷", "📪", "📫", "📬", "📭", "📮", "📯", "📜", "📃", "📄", "📑", "🧾", "📊", "📈", "📉", "🗒", "🗓", "📆", "📅", "🗑", "📇", "🗃", "🗳", "🗄", "📋", "📁", "📂", "🗂", "🗞", "📰", "📓", "📔", "📒", "📕", "📗", "📘", "📙", "📚", "📖", "🔖", "🧷", "🔗", "📎", "🖇", "📐", "📏", "🧮", "📌", "📍", "✂️", "🖊", "🖋", "✒️", "🖌", "🖍", "📝", "✏️", "🔍", "🔎", "🔏", "🔐", "🔒", "🔓"]
        },
        {
          name: "Activities",
          icons: ["🎯", "🎮", "🎲", "🧩", "🎭", "🎨", "👟", "🏆", "🏅", "🥇", "🥈", "🥉", "⚽", "⚾", "🏀", "🏐", "🏈", "🏉", "🎾", "🥏", "🎳", "🏏", "🏑", "🏒", "🥍", "🏓", "🏸", "🥊", "🥋", "🥅", "⛳", "⛸", "🎣", "🤿", "🎽", "🎿", "🛷", "🥌", "🎯", "🪀", "🪁", "🎱", "🔮", "🧿", "🎮", "🎰", "🎲", "🧩", "🧸", "♟️", "🎭", "🎨", "🧵", "🧶", "👓", "🕶", "🥽", "🥼", "🦺", "👔", "👕", "👖", "🧣", "🧤", "🧥", "🧦", "👗", "👘", "🥻", "🩱", "🩲", "🩳", "👙", "👚", "👛", "👜", "👝", "🛍", "🎒", "👞", "👟", "🥾", "🥿", "👠", "👡", "🩰", "👢", "👑", "👒", "🎩", "🎓", "🧢", "⛑", "📿", "💄", "💍", "💎", "📱", "📲", "💻", "⌨️", "🖥", "🖨", "🖱", "🖲", "🕹", "🗜", "💽", "💾", "💿", "📀", "📼", "📷", "📸", "📹", "🎥", "📽", "🎞", "📞", "☎️", "📟", "📠", "📺", "📻", "🎙", "🎚", "🎛", "🧭", "⏱", "⏲", "⏰", "🕰", "⌛", "⏳", "📡", "🔋", "🔌", "💡", "🔦", "🕯", "🪔", "🧯", "🛢", "💸", "💵", "💴", "💶", "💷", "💰", "💳", "💎", "⚖️", "🧰", "🔧", "🔨", "⚒", "🛠", "⛏", "🔩", "⚙️", "🧱", "⛓", "🧲", "🔫", "💣", "🧨", "🪓", "🔪", "🗡", "⚔️", "🛡", "🚬", "⚰️", "⚱️", "🏺", "🔮", "📿", "🧿", "💈", "⚗️", "🔭", "🔬", "🕳", "🩹", "🩺", "💊", "💉", "🩸", "🧬", "🦠", "🧫", "🧪", "🌡", "🧹", "🧺", "🧻", "🚽", "🚰", "🚿", "🛁", "🛀", "🧼", "🪒", "🧽", "🧴", "🛎", "🔑", "🗝", "🚪", "🪑", "🛋", "🛏", "🛌", "🧸", "🖼", "🛍", "🛒", "🎁", "🎈", "🎏", "🎀", "🎊", "🎉", "🎎", "🏮", "🎐", "🧧", "✉️", "📩", "📨", "📧", "💌", "📥", "📤", "📦", "🏷", "📪", "📫", "📬", "📭", "📮", "📯", "📜", "📃", "📄", "📑", "🧾", "📊", "📈", "📉", "🗒", "🗓", "📆", "📅", "🗑", "📇", "🗃", "🗳", "🗄", "📋", "📁", "📂", "🗂", "🗞", "📰", "📓", "📔", "📒", "📕", "📗", "📘", "📙", "📚", "📖", "🔖", "🧷", "🔗", "📎", "🖇", "📐", "📏", "🧮", "📌", "📍", "✂️", "🖊", "🖋", "✒️", "🖌", "🖍", "📝", "✏️", "🔍", "🔎", "🔏", "🔐", "🔒", "🔓"]
        },
        {
          name: "Food",
          icons: ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🥭", "🍍", "🥥", "🥝", "🍅", "🍆", "🥑", "🥦", "🥬", "🥒", "🌶", "🌽", "🥕", "🧄", "🧅", "🥔", "🍠", "🥐", "🥯", "🍞", "🥖", "🥨", "🧀", "🥚", "🍳", "🧈", "🥞", "🧇", "🥓", "🥩", "🍗", "🍖", "🦴", "🌭", "🍔", "🍟", "🍕", "🥪", "🥙", "🧆", "🌮", "🌯", "🥗", "🥘", "🥫", "🍝", "🍜", "🍲", "🍛", "🍣", "🍱", "🥟", "🦪", "🍤", "🍙", "🍚", "🍘", "🍥", "🥠", "🥮", "🍢", "🍡", "🍧", "🍨", "🍦", "🥧", "🧁", "🍰", "🎂", "🍮", "🍭", "🍬", "🍫", "🍿", "🍩", "🍪", "🌰", "🥜", "🍯", "🥛", "🍼", "☕", "🍵", "🧃", "🥤", "🍶", "🍺", "🍻", "🥂", "🍷", "🥃", "🍸", "🍹", "🧉", "🍾", "🧊", "🥄", "🍴", "🍽", "🥣", "🥡", "🥢", "🧂"]
        },
        {
          name: "Travel",
          icons: ["🚗", "🚕", "🚙", "🚌", "🚎", "🏎", "🚓", "🚑", "🚒", "🚐", "🚚", "🚛", "🚜", "🦯", "🦽", "🦼", "🛴", "🚲", "🛵", "🏍", "🛺", "🚨", "🚔", "🚍", "🚘", "🚖", "🚡", "🚠", "🚟", "🚃", "🚋", "🚞", "🚝", "🚄", "🚅", "🚈", "🚂", "🚆", "🚇", "🚊", "🚉", "✈️", "🛫", "🛬", "🛩", "💺", "🛰", "🚀", "🛸", "🚁", "🛶", "⛵", "🚤", "🛥", "🛳", "⛴", "🚢", "⚓", "⛽", "🚧", "🚦", "🚥", "🚏", "🗺", "🗿", "🗽", "🗼", "🏰", "🏯", "🏟", "🎡", "🎢", "🎠", "⛲", "⛱", "🏖", "🏝", "🏜", "🌋", "⛰", "🏔", "🗻", "🏕", "⛺", "🏠", "🏡", "🏘", "🏚", "🏗", "🏭", "🏢", "🏬", "🏣", "🏤", "🏥", "🏦", "🏨", "🏪", "🏫", "🏩", "💒", "🏛", "⛪", "🕌", "🕍", "🛕", "🕋", "⛩", "🛤", "🛣", "🗾", "🎑", "🏞", "🌅", "🌄", "🌠", "🎇", "🎆", "🌇", "🌆", "🏙", "🌃", "🌌", "🌉", "🌁"]
        },
        {
          name: "Symbols",
          icons: ["❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔", "❣️", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💟", "☮️", "✝️", "☪️", "🕉", "☸️", "✡️", "🔯", "🕎", "☯️", "☦️", "🛐", "⛎", "♈", "♉", "♊", "♋", "♌", "♍", "♎", "♏", "♐", "♑", "♒", "♓", "🆔", "⚛️", "🉑", "☢️", "☣️", "📴", "📳", "🈶", "🈚", "🈸", "🈺", "🈷️", "✴️", "🆚", "💮", "🉐", "㊙️", "㊗️", "🈴", "🈵", "🈹", "🈲", "🅰️", "🅱️", "🆎", "🆑", "🅾️", "🆘", "❌", "⭕", "🛑", "⛔", "📛", "🚫", "💯", "💢", "♨️", "🚷", "🚯", "🚳", "🚱", "🔞", "📵", "🚭", "❗", "❕", "❓", "❔", "‼️", "⁉️", "🔅", "🔆", "〽️", "⚠️", "🚸", "🔱", "⚜️", "🔰", "♻️", "✅", "🈯", "💹", "❇️", "✳️", "❎", "🌐", "💠", "Ⓜ️", "🌀", "💤", "🏧", "🚾", "♿", "🅿️", "🈳", "🈂️", "🛂", "🛃", "🛄", "🛅", "🚹", "🚺", "🚼", "⚧", "🚻", "🚮", "🎦", "📶", "🈁", "🔣", "ℹ️", "🔤", "🔡", "🔠", "🆖", "🆗", "🆙", "🆒", "🆕", "🆓", "0️⃣", "1️⃣", "2️⃣", "3️⃣", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣", "9️⃣", "🔟", "🔢", "#️⃣", "*️⃣", "⏏️", "▶️", "⏸", "⏯", "⏹", "⏺", "⏭", "⏮", "⏩", "⏪", "⏫", "⏬", "◀️", "🔼", "🔽", "➡️", "⬅️", "⬆️", "⬇️", "↗️", "↘️", "↙️", "↖️", "↕️", "↔️", "↪️", "↩️", "⤴️", "⤵️", "🔀", "🔁", "🔂", "🔄", "🔃", "🎵", "🎶", "➕", "➖", "➗", "✖️", "♾", "💲", "💱", "™️", "©️", "®️", "〰️", "➰", "➿", "🔚", "🔙", "🔛", "🔝", "🔜", "✔️", "☑️", "🔘", "🔴", "🟠", "🟡", "🟢", "🔵", "🟣", "⚫", "⚪", "🟤", "🔺", "🔻", "🔸", "🔹", "🔶", "🔷", "🔳", "🔲", "▪️", "▫️", "◾", "◽", "◼️", "◻️", "🟥", "🟧", "🟨", "🟩", "🟦", "🟪", "⬛", "⬜", "🟫", "🔈", "🔇", "🔉", "🔊", "🔔", "🔕", "📣", "📢", "👁‍🗨", "💬", "💭", "🗯", "♠️", "♣️", "♥️", "♦️", "🃏", "🎴", "🀄", "🕐", "🕑", "🕒", "🕓", "🕔", "🕕", "🕖", "🕗", "🕘", "🕙", "🕚", "🕛", "🕜", "🕝", "🕞", "🕟", "🕠", "🕡", "🕢", "🕣", "🕤", "🕥", "🕦", "🕧"]
        }
      ]);

      // Add state for emoji search
      const [emojiSearchTerm, setEmojiSearchTerm] = React.useState('');
      const [filteredCategories, setFilteredCategories] = React.useState([]);
      
      // Function to filter emojis based on search term
      React.useEffect(() => {
        if (!emojiSearchTerm.trim()) {
          setFilteredCategories(iconCategories);
          return;
        }
        
        // Define emoji keywords for better searchability
        const emojiKeywords = {
          // Faces category
          "😊": ["smile", "happy", "smiling", "face"],
          "😃": ["happy", "smile", "grin", "face"],
          "😄": ["laugh", "happy", "smile", "grin", "face"],
          "😁": ["grin", "happy", "smile", "face"],
          "😆": ["laugh", "happy", "smile", "face"],
          "😅": ["sweat", "smile", "happy", "face"],
          "😂": ["laugh", "joy", "tears", "happy", "face"],
          "🤣": ["rofl", "laugh", "joy", "tears", "happy", "face"],
          "😍": ["love", "heart", "eyes", "face"],
          "🥰": ["love", "smiling", "hearts", "face"],
          "😘": ["kiss", "love", "face"],
          "😗": ["kiss", "face"],
          "😙": ["kiss", "smiling", "face"],
          "😚": ["kiss", "closed", "eyes", "face"],
          "😋": ["yum", "tongue", "delicious", "face"],
          "😛": ["tongue", "face"],
          "😜": ["wink", "tongue", "face"],
          "😝": ["tongue", "closed", "eyes", "face"],
          "🤑": ["money", "mouth", "rich", "face"],
          "🤗": ["hug", "arms", "open", "face"],
          "🤔": ["think", "thinking", "thoughtful", "face"],
          "🤐": ["zip", "quiet", "silent", "face"],
          "😐": ["neutral", "face"],
          "😑": ["expressionless", "face"],
          "😶": ["no", "mouth", "face"],
          "😏": ["smirk", "face"],
          "😒": ["unamused", "face"],
          "🙄": ["rolling", "eyes", "face"],
          "😬": ["grimace", "face"],
          "🤥": ["lie", "liar", "nose", "pinocchio", "face"],
          "😌": ["relieved", "face"],
          "😔": ["sad", "pensive", "thoughtful", "face"],
          "😪": ["sleepy", "tired", "face"],
          "🤤": ["drooling", "face"],
          "😴": ["sleep", "zzz", "face"],
          "😷": ["mask", "sick", "ill", "face"],
          "🤒": ["thermometer", "sick", "ill", "face"],
          "🤕": ["bandage", "hurt", "injury", "face"],
          "🤢": ["nauseated", "sick", "ill", "green", "face"],
          "🤮": ["vomit", "sick", "ill", "face"],
          "🤧": ["sneeze", "sick", "ill", "face"],
          "😵": ["dizzy", "face"],
          "🤯": ["exploding", "mind", "blown", "face"],
          "🥳": ["party", "celebration", "face"],
          "😎": ["cool", "sunglasses", "face"],
          "🧐": ["monocle", "sophisticated", "face"],
          "😕": ["confused", "face"],
          "😟": ["worried", "face"],
          "🙁": ["sad", "slightly", "frown", "face"],
          "☹️": ["sad", "frown", "face"],
          
          // Animals (selected few to keep file size reasonable)
          "🐶": ["dog", "puppy", "animal"],
          "🐱": ["cat", "kitten", "animal"],
          "🐭": ["mouse", "animal"],
          "🐹": ["hamster", "animal"],
          "🐰": ["rabbit", "bunny", "animal"],
          "🦊": ["fox", "animal"],
          "🐻": ["bear", "animal"],
          "🐼": ["panda", "animal"],
          "🐨": ["koala", "animal"],
          "🐯": ["tiger", "animal"],
          "🦁": ["lion", "animal"],
          
          // Objects (selected few)
          "⭐": ["star", "object"],
          "🌟": ["star", "glow", "object"],
          "✨": ["sparkles", "object"],
          "💫": ["dizzy", "star", "object"],
          "🪄": ["wand", "magic", "object"],
          "🔮": ["crystal", "ball", "magic", "object"],
          "🎮": ["game", "controller", "object"],
          "🎲": ["dice", "game", "object"],
          
          // Food (selected few)
          "🍏": ["apple", "green", "food", "fruit"],
          "🍎": ["apple", "red", "food", "fruit"],
          "🍐": ["pear", "food", "fruit"],
          "🍊": ["orange", "tangerine", "food", "fruit"],
          "🍋": ["lemon", "food", "fruit"],
          "🍌": ["banana", "food", "fruit"],
          
          // Symbols (selected few)
          "❤️": ["heart", "love", "red", "symbol"],
          "🧡": ["heart", "love", "orange", "symbol"],
          "💛": ["heart", "love", "yellow", "symbol"],
          "💚": ["heart", "love", "green", "symbol"],
          "💙": ["heart", "love", "blue", "symbol"],
          "💜": ["heart", "love", "purple", "symbol"],
          
          // Activities
          "🎯": ["target", "bullseye", "dart", "game", "activity"],
          "🎮": ["controller", "video", "game", "activity"],
          "🎲": ["dice", "game", "activity"],
          "🧩": ["puzzle", "piece", "game", "activity"],
          "🎭": ["theater", "drama", "masks", "activity"],
          "🎨": ["art", "palette", "paint", "activity"],
          "👟": ["shoe", "sneaker", "running", "activity"],
          "🏆": ["trophy", "prize", "award", "activity"],
          "🏅": ["medal", "award", "activity"],
          "⚽": ["soccer", "football", "ball", "sport", "activity"],
          "⚾": ["baseball", "ball", "sport", "activity"],
          "🏀": ["basketball", "ball", "sport", "activity"],
          "🏐": ["volleyball", "ball", "sport", "activity"],
          "🏈": ["football", "american", "sport", "activity"],
          "🎾": ["tennis", "ball", "sport", "activity"],
          "🎳": ["bowling", "sport", "activity"],
          
          // Travel
          "🚗": ["car", "auto", "automobile", "vehicle", "travel"],
          "🚕": ["taxi", "cab", "car", "vehicle", "travel"],
          "🚙": ["suv", "car", "vehicle", "travel"],
          "🚌": ["bus", "vehicle", "travel"],
          "🏎": ["race", "car", "vehicle", "travel"],
          "🚓": ["police", "car", "vehicle", "travel"],
          "🚑": ["ambulance", "emergency", "vehicle", "travel"],
          "🚒": ["fire", "truck", "engine", "vehicle", "travel"],
          "🚲": ["bicycle", "bike", "cycling", "travel"],
          "🛴": ["scooter", "travel"],
          "🏍": ["motorcycle", "bike", "travel"],
          "✈️": ["airplane", "plane", "flight", "travel"],
          "🛫": ["takeoff", "airport", "plane", "travel"],
          "🛬": ["landing", "airport", "plane", "travel"],
          "🚀": ["rocket", "space", "travel"],
          "🛸": ["ufo", "flying", "saucer", "travel"],
          "🚁": ["helicopter", "chopper", "travel"],
          "⛵": ["boat", "sailing", "ship", "travel"]
        };
        
        const searchTermLower = emojiSearchTerm.toLowerCase();
        
        const filtered = iconCategories.map(category => {
          const categoryNameMatch = category.name.toLowerCase().includes(searchTermLower);
          
          return {
            name: category.name,
            icons: category.icons.filter(icon => {
              // If searching by category name, include all icons in that category
              if (categoryNameMatch) {
                return true;
              }
              
              // Check if the emoji has keywords defined
              if (emojiKeywords[icon]) {
                return emojiKeywords[icon].some(keyword => 
                  keyword.includes(searchTermLower) || searchTermLower.includes(keyword)
                );
              }
              // Fallback to try direct matching
              return icon.includes(searchTermLower);
            })
          };
        }).filter(category => category.icons.length > 0);
        
        setFilteredCategories(filtered);
      }, [emojiSearchTerm, iconCategories]);

      // Get the active kid's data
      const activeKid = kids.find(kid => kid.id === activeKidId) || kids[0];
      const activeKidData = kidsData[activeKidId] || kidsData[1];
      
      // Shorthand getters/setters for active kid's data
      const currentPoints = activeKidData.points;
      const setCurrentPoints = (pointsUpdater) => {
        const newPoints = typeof pointsUpdater === 'function' 
          ? pointsUpdater(activeKidData.points) 
          : pointsUpdater;
        
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          points: newPoints
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // Debug log
        console.log(`Updated points for kid ${activeKidId}: ${newPoints}`);
      };
      
      const behaviors = activeKidData.behaviors;
      const setBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.behaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          behaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // IMPORTANT: Force a re-render after state update
        setTimeout(() => {
          console.log("Updated behaviors state:", kidsData[activeKidId].behaviors);
        }, 0);
        
        // Debug log
        console.log(`Updated behaviors for kid ${activeKidId}:`, newBehaviors);
      };
      
      const dailyBehaviorLogs = activeKidData.dailyBehaviorLogs;
      const setDailyBehaviorLogs = (logsUpdater) => {
        const newLogs = typeof logsUpdater === 'function'
          ? logsUpdater(activeKidData.dailyBehaviorLogs)
          : logsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          dailyBehaviorLogs: newLogs
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
        
        // Debug log
        console.log(`Updated daily logs for kid ${activeKidId}:`, newLogs);
      };
      
      const goodBehaviors = activeKidData.goodBehaviors;
      const setGoodBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.goodBehaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          goodBehaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };
      
      const badBehaviors = activeKidData.badBehaviors;
      const setBadBehaviors = (behaviorsUpdater) => {
        const newBehaviors = typeof behaviorsUpdater === 'function'
          ? behaviorsUpdater(activeKidData.badBehaviors)
          : behaviorsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          badBehaviors: newBehaviors
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };
      
      const rewards = activeKidData.rewards;
      const setRewards = (rewardsUpdater) => {
        const newRewards = typeof rewardsUpdater === 'function'
          ? rewardsUpdater(activeKidData.rewards)
          : rewardsUpdater;
          
        // Create a new reference to ensure React detects the change
        const updatedKidData = {
          ...activeKidData,
          rewards: newRewards
        };
        
        // Create a new reference for kidsData to ensure React detects the change
        setKidsData({
          ...kidsData,
          [activeKidId]: updatedKidData
        });
      };

      // Function to remove a behavior from daily logs
      const removeBehavior = (logId) => {
        // Ask for confirmation before removing
        if (confirm("Are you sure you want to remove this behavior?")) {
          const dateKey = formatDateKey(selectedDate);
          
          console.log(`REMOVING BEHAVIOR - Log ID: ${logId}, Date: ${dateKey}`);
          
          // Get current kid data directly from state to ensure we have the latest
          const currentKidData = {...kidsData[activeKidId]};
          
          // Get current logs for this date
          const currentDateLogs = currentKidData.dailyBehaviorLogs[dateKey] || [];
          
          // Find the log entry to be removed
          const logToRemove = currentDateLogs.find(log => log.id === logId);
          
          if (logToRemove) {
            console.log(`REMOVING - Found log to remove:`, logToRemove);
            
            // Adjust points based on the removed behavior
            const pointsAdjustment = logToRemove.type === 'good' 
              ? -logToRemove.points  // Subtract points for good behavior
              : logToRemove.points;  // Add back points for bad behavior
            
            // Update daily behavior counts
            const currentDayBehaviors = currentKidData.behaviors[dateKey] || { good: 0, bad: 0 };
            const updatedDayBehaviors = {
              ...currentDayBehaviors,
              [logToRemove.type]: Math.max(0, (currentDayBehaviors[logToRemove.type] || 0) - 1)
            };
            
            console.log(`REMOVING - Updating day behaviors from`, currentDayBehaviors, `to`, updatedDayBehaviors);
            
            // Create updated logs with the behavior removed
            const updatedLogs = currentDateLogs.filter(log => log.id !== logId);
            
            // Create a single updated kid data object with all changes
            const updatedKidData = {
              ...currentKidData,
              points: currentKidData.points + pointsAdjustment,
              behaviors: {
                ...currentKidData.behaviors,
                [dateKey]: updatedDayBehaviors
              },
              dailyBehaviorLogs: {
                ...currentKidData.dailyBehaviorLogs,
                [dateKey]: updatedLogs
              }
            };
            
            // Update all kid data in a single operation
            setKidsData({
              ...kidsData,
              [activeKidId]: updatedKidData
            });
            
            console.log(`REMOVING - Updated kid data:`, updatedKidData);
            console.log(`REMOVING - Adjusting points by ${pointsAdjustment}, new total: ${updatedKidData.points}`);
            
            // Force immediate UI refresh
            setRenderTrigger(prev => prev + 1);
            
            // Force another UI refresh after a small delay to ensure changes are visible
            setTimeout(() => {
              console.log("VERIFYING REMOVAL - Checking if UI has updated");
              
              // Verify the current state after the update
              console.log("Current kid data:", kidsData[activeKidId]);
              console.log(`Current behaviors for ${dateKey}:`, kidsData[activeKidId]?.behaviors?.[dateKey]);
              console.log(`Current logs for ${dateKey}:`, kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey]);
              
              // Force another render update
              setRenderTrigger(prev => prev + 1);
              
              // Also force a date change to trigger calendar-related updates
              const refreshDate = new Date(selectedDate);
              refreshDate.setMilliseconds(refreshDate.getMilliseconds() + 1);
              setSelectedDate(refreshDate);
            }, 50);
          }
        }
      };

      // Kid management functions
      const addKid = () => {
        if (newKid.name) {
          const newKidId = Math.max(0, ...kids.map(k => k.id)) + 1;
          
          // Add new kid to kids list
          setKids([...kids, { ...newKid, id: newKidId }]);
          
          // Initialize data structure for the new kid
          setKidsData({
            ...kidsData,
            [newKidId]: {
              points: 0,
              behaviors: {},
              dailyBehaviorLogs: {},
              goodBehaviors: [
                { id: 1, description: "Cleaning up toys", points: 2, icon: "🧹" },
                { id: 2, description: "Helping a sibling", points: 3, icon: "🤝" },
                { id: 3, description: "Completing homework", points: 2, icon: "📚" },
                { id: 4, description: "Brushing teeth without reminder", points: 1, icon: "🪥" },
                { id: 5, description: "Setting the table", points: 1, icon: "🍽️" }
              ],
              badBehaviors: [
                { id: 1, description: "Not listening", points: 1, icon: "👂" },
                { id: 2, description: "Fighting with siblings", points: 2, icon: "😠" },
                { id: 3, description: "Not finishing food", points: 1, icon: "🍽️" },
                { id: 4, description: "Screen time without permission", points: 2, icon: "📱" },
                { id: 5, description: "Bedtime tantrum", points: 3, icon: "😭" }
              ],
              rewards: [
                { id: 1, name: "Playground Time", points: 20, claimed: false, icon: "🛝" },
                { id: 2, name: "Ice Cream", points: 30, claimed: false, icon: "🍦" },
                { id: 3, name: "Movie Night", points: 50, claimed: false, icon: "🎬" },
                { id: 4, name: "New Toy", points: 100, claimed: false, icon: "🧸" }
              ]
            }
          });
          
          // Reset form
          setNewKid({ name: "", avatar: "👶" });
          setIsAddingKid(false);
          
          // Switch to the new kid
          setActiveKidId(newKidId);
        }
      };
      
      const editKid = (id, updatedKid) => {
        setKids(kids.map(kid => 
          kid.id === id ? { ...kid, ...updatedKid } : kid
        ));
      };
      
      const deleteKid = (id) => {
        // Don't allow deleting the last kid
        if (kids.length <= 1) {
          alert("You must have at least one child in the tracker.");
          return;
        }
        
        // Confirm before deletion
        if (!confirm(`Are you sure you want to delete ${kids.find(k => k.id === id)?.name}?`)) {
          return;
        }
        
        // Remove the kid
        setKids(kids.filter(kid => kid.id !== id));
        
        // If the active kid was deleted, switch to another kid
        if (activeKidId === id) {
          const remainingKidId = kids.find(kid => kid.id !== id)?.id || kids[0].id;
          setActiveKidId(remainingKidId);
        }
        
        // Remove the kid's data
        const { [id]: _, ...remainingKidsData } = kidsData;
        setKidsData(remainingKidsData);
      };
      
      // Switch active kid
      const switchKid = (id) => {
        console.log(`Switching from kid ${activeKidId} to kid ${id}`);
        
        // Get current kid data
        const currentKidData = kidsData[id] || {};
        console.log(`New kid's data:`, currentKidData);
        
        setActiveKidId(id);
        
        // Reset behavior selections when switching
        setSelectedGoodBehavior(null);
        setSelectedBadBehavior(null);
        
        // Force UI refresh
        setSelectedDate(new Date(selectedDate));
      };
      
      // Kid manager component
      const renderKidManager = () => {
        if (!showKidManager) return null;
        
        return (
          <div className="modal-backdrop">
            <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Kid Manager</h2>
                <button
                  onClick={() => setShowKidManager(false)}
                  className="text-2xl hover:text-gray-700">
                  ×
                </button>
              </div>
              
              {/* List of kids */}
              <div className="mb-4">
                {kids.length > 0 ? (
                  kids.map(kid => (
                    <div 
                      key={kid.id} 
                      className={`flex items-center justify-between p-3 my-2 ${kid.id === activeKidId ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50'} rounded-lg`}
                    >
                      <div className="flex items-center">
                        <span className="text-2xl mr-3">{kid.avatar}</span>
                        <div className="flex-1">
                          <div className="font-medium">{kid.name}</div>
                          <div className="text-sm text-gray-600">
                            {kidsData[kid.id]?.points || 0} stars earned
                          </div>
                        </div>
                      </div>
                      <div className="flex space-x-2">
                        <button 
                          onClick={() => {
                            const newName = prompt("Enter new name:", kid.name);
                            const newAvatar = prompt("Enter new avatar emoji:", kid.avatar);
                            if (newName && newName.trim() !== "") {
                              editKid(kid.id, { 
                                name: newName, 
                                avatar: newAvatar && newAvatar.trim() !== "" ? newAvatar : kid.avatar 
                              });
                            }
                          }}
                          className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                        >
                          Edit
                        </button>
                        {kid.id !== activeKidId && (
                          <button 
                            onClick={() => switchKid(kid.id)}
                            className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                          >
                            Select
                          </button>
                        )}
                        <button 
                          onClick={() => deleteKid(kid.id)}
                          className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-4 text-gray-500">
                    No children added yet
                  </div>
                )}
              </div>
              
              {/* Add new kid form */}
              {isAddingKid ? (
                <div className="p-4 border-2 border-dashed border-blue-300 rounded-lg">
                  <div className="flex mb-2 items-center">
                    <input
                      type="text"
                      placeholder="Avatar"
                      value={newKid.avatar}
                      onChange={e => setNewKid({ ...newKid, avatar: e.target.value })}
                      className="w-16 p-2 border rounded-lg mr-2 text-center text-xl"
                    />
                    <input
                      type="text"
                      placeholder="Child's name"
                      value={newKid.name}
                      onChange={e => setNewKid({ ...newKid, name: e.target.value })}
                      className="flex-1 p-2 border rounded-lg"
                    />
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={addKid}
                      className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg"
                    >
                      Add Child
                    </button>
                    <button
                      onClick={() => {
                        setNewKid({ name: "", avatar: "👶" });
                        setIsAddingKid(false);
                      }}
                      className="flex-1 bg-gray-300 hover:bg-gray-400 py-2 rounded-lg"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              ) : (
                <button
                  onClick={() => setIsAddingKid(true)}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg"
                >
                  Add New Child
                </button>
              )}
            </div>
          </div>
        );
      };
      
      // Initialize p5.js or use CSS animation fallback
      React.useEffect(() => {
        // Skip p5.js initialization if the simple background is enabled
        if (useSimpleBackground) {
          const container = document.getElementById('p5-container');
          if (container) {
            container.style.display = 'none';
          }
          document.body.classList.add('simple-background');
          return;
        }
        
        try {
          // p5.js sketch for background animations - explicitly avoiding all sensor APIs
          new p5((p) => {
            // Explicitly disable device orientation and motion events
            p.deviceOrientation = undefined;
            p.deviceMoved = undefined;
            p.deviceTurned = undefined;
            p.deviceShaken = undefined;
            
            const particles = [];
            const colors = ['#4338ca', '#3b82f6', '#60a5fa', '#93c5fd'];
            let canvasWidth = window.innerWidth;
            let canvasHeight = window.innerHeight;

            p.setup = () => {
              p.createCanvas(canvasWidth, canvasHeight);
              initializeParticles();
              
              // Disable any orientation-related features
              if (p.setShakeThreshold) {
                p.setShakeThreshold(9999); // Effectively disable shake detection
              }
            };

            function initializeParticles() {
              particles.length = 0; // Clear existing particles
              for (let i = 0; i < 30; i++) {
                particles.push({
                  x: p.random(canvasWidth),
                  y: p.random(canvasHeight),
                  size: p.random(5, 15),
                  color: p.random(colors),
                  speedX: p.random(-0.5, 0.5),
                  speedY: p.random(-0.5, 0.5)
                });
              }
            }

            p.draw = () => {
              p.clear();

              particles.forEach(particle => {
                p.noStroke();
                p.fill(particle.color);
                p.ellipse(particle.x, particle.y, particle.size);

                particle.x += particle.speedX;
                particle.y += particle.speedY;

                if (particle.x < 0 || particle.x > canvasWidth) particle.speedX *= -1;
                if (particle.y < 0 || particle.y > canvasHeight) particle.speedY *= -1;
              });
            };

            p.windowResized = () => {
              canvasWidth = window.innerWidth;
              canvasHeight = window.innerHeight;
              p.resizeCanvas(canvasWidth, canvasHeight);
              initializeParticles();
            };
          }, 'p5-container');
        } catch (error) {
          console.error("P5.js initialization error:", error);
          // Log specific info if it's a sensor-related error
          if (error.message && (
            error.message.includes('orientation') || 
            error.message.includes('sensor') || 
            error.message.includes('permission')
          )) {
            console.info("This appears to be a sensor permission error. Disabling p5.js animations.");
          }
          
          // Gracefully handle p5.js failure - remove the container to prevent further errors
          const container = document.getElementById('p5-container');
          if (container) {
            container.style.display = 'none';
          }
          
          // Provide a simple fallback background if p5 fails
          document.body.style.background = 'linear-gradient(to right, #f0f4fd, #e6eefa)';
        }
      }, [useSimpleBackground]);

      // Force re-render on critical state changes
      React.useEffect(() => {
        console.log(`Critical state changed - Forcing refresh`);
        console.log(`Current kid: ${activeKid.name} (ID: ${activeKidId})`);
        
        // The selectedDate is updated to force a re-render
        const newDate = new Date(selectedDate);
        newDate.setMilliseconds(newDate.getMilliseconds() + Math.random() * 100);
        setSelectedDate(newDate);
        
        // Also increment render trigger to ensure components re-render
        setRenderTrigger(prev => prev + 1);
      }, [activeKidId, JSON.stringify(kidsData)]);
      
      // Save app state to localStorage whenever critical state changes
      React.useEffect(() => {
        // Only save if kids array is not empty
        if (kids.length > 0) {
          saveAppState(kids, activeKidId, kidsData);
        }
      }, [kids, activeKidId, kidsData]);
      
      // Additional UI refresh when behaviors or logs change
      React.useEffect(() => {
        if (activeKidId && kidsData[activeKidId]) {
          console.log(`Detected change in behaviors or logs - Refreshing UI`);
          
          // Increment render trigger
          setRenderTrigger(prev => prev + 1);
          
          // Force re-render
          const refreshDate = new Date(selectedDate);
          refreshDate.setMilliseconds(refreshDate.getMilliseconds() + Math.random() * 100);
          setSelectedDate(refreshDate);
        }
      }, [
        activeKidId, 
        // Use the actual behaviors and logs in dependencies, not stringify
        kidsData[activeKidId]?.behaviors, 
        kidsData[activeKidId]?.dailyBehaviorLogs,
        // Also watch points
        kidsData[activeKidId]?.points
      ]);

      // CRITICAL NEW EFFECT: Watch specific date behaviors to force UI update when they change
      React.useEffect(() => {
        if (activeKidId && kidsData[activeKidId]) {
          const dateKey = formatDateKey(selectedDate);
          const dateBehaviors = kidsData[activeKidId]?.behaviors?.[dateKey];
          const dateLogs = kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey];
          
          console.log(`Selected date ${dateKey} behaviors/logs changed - VERIFYING DATA`);
          console.log(`Current behaviors for date ${dateKey}:`, dateBehaviors);
          console.log(`Current logs for date ${dateKey}:`, dateLogs);
          
          // Verify date key is consistent
          if (selectedDate) {
            const formattedKey = formatDateKey(selectedDate);
            console.log(`Verifying date key formatting - Current selected date: ${selectedDate.toISOString()}`);
            console.log(`Formatted as key: ${formattedKey}`);
            
            // Force a re-render if data has changed
            setRenderTrigger(prev => prev + 1);
          }
        }
      }, [
        selectedDate, 
        activeKidId,
        // Watch only behaviors and logs for the selected date
        JSON.stringify(kidsData[activeKidId]?.behaviors?.[formatDateKey(selectedDate)] || {}),
        JSON.stringify(kidsData[activeKidId]?.dailyBehaviorLogs?.[formatDateKey(selectedDate)] || [])
      ]);

      // Force re-render when switching kids
      React.useEffect(() => {
        console.log(`Active kid changed to ${activeKid.name} (ID: ${activeKidId})`);
        // No need to do anything else - this dependency will trigger a re-render
      }, [activeKidId]);

      // Handle behavior recording with specific behavior selection
      const recordBehavior = () => {
        const dateKey = formatDateKey(selectedDate);
        
        console.log(`STARTING RECORD BEHAVIOR - Date: ${dateKey}, Kid: ${activeKid.name}(${activeKidId})`);
        
        // Get selected behavior
        const selectedBehavior = activeBehavior === 'good'
          ? goodBehaviors.find(b => b.id === selectedGoodBehavior)
          : badBehaviors.find(b => b.id === selectedBadBehavior);

        if (!selectedBehavior) {
          alert(`Please select a ${activeBehavior} behavior first`);
          return;
        }

        console.log(`Selected ${activeBehavior} behavior:`, selectedBehavior);
        
        // Get the most current kid data from state
        const currentKidData = {...kidsData[activeKidId]};
        console.log("Current kid data before update:", currentKidData);
        
        // Get current behaviors and logs for this date 
        const currentDayBehaviors = currentKidData.behaviors[dateKey] || { good: 0, bad: 0 };
        const currentDateLogs = currentKidData.dailyBehaviorLogs[dateKey] || [];
        
        console.log("Current day behaviors:", currentDayBehaviors);
        console.log("Current date logs:", currentDateLogs);
        
        // Create updated day behaviors
        const updatedDayBehaviors = {
          ...currentDayBehaviors,
          [activeBehavior]: (currentDayBehaviors[activeBehavior] || 0) + 1
        };
        
        // Create new log entry
        const newLog = {
          id: Date.now(),
          type: activeBehavior,
          behaviorId: selectedBehavior.id,
          description: selectedBehavior.description,
          points: selectedBehavior.points,
          icon: selectedBehavior.icon,
          timestamp: new Date().toLocaleTimeString()
        };
        
        // Calculate new points
        const newPoints = activeBehavior === 'good'
          ? currentKidData.points + selectedBehavior.points
          : Math.max(0, currentKidData.points - selectedBehavior.points);
        
        // Create a single updated kid data object
        const updatedKidData = {
          ...currentKidData,
          points: newPoints,
          behaviors: {
            ...currentKidData.behaviors,
            [dateKey]: updatedDayBehaviors
          },
          dailyBehaviorLogs: {
            ...currentKidData.dailyBehaviorLogs,
            [dateKey]: [...currentDateLogs, newLog]
          }
        };
        
        // Update all kid data in a single operation
        setKidsData(prevKidsData => ({
          ...prevKidsData,
          [activeKidId]: updatedKidData
        }));
        
        console.log("AFTER UPDATE - Full updated kid data:", updatedKidData);
        console.log(`AFTER UPDATE - Day behaviors for ${dateKey}:`, updatedKidData.behaviors[dateKey]);
        console.log(`AFTER UPDATE - Day logs for ${dateKey}:`, updatedKidData.dailyBehaviorLogs[dateKey]);
        
        // Handle confetti for good behaviors
        if (activeBehavior === 'good') {
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 3000);
        }

        // Reset behavior selection
        if (activeBehavior === 'good') {
          setSelectedGoodBehavior(null);
        } else {
          setSelectedBadBehavior(null);
        }
        
        // Force UI refresh with render trigger (keep this to ensure UI updates)
        setRenderTrigger(prev => prev + 1);
        
        // Force another UI refresh after a delay to ensure changes are visible
        setTimeout(() => {
          console.log("VERIFYING UPDATE - Current kid data after delay:", kidsData[activeKidId]);
          console.log(`VERIFYING UPDATE - Day behaviors after delay:`, kidsData[activeKidId]?.behaviors?.[dateKey]);
          console.log(`VERIFYING UPDATE - Day logs after delay:`, kidsData[activeKidId]?.dailyBehaviorLogs?.[dateKey]);
          setRenderTrigger(prev => prev + 1);
        }, 100);
      };

      // Add a new behavior
      const addBehavior = () => {
        if (newBehavior.description && newBehavior.points > 0) {
          if (isEditingBehavior && behaviorToEdit) {
            // Edit existing behavior
            if (behaviorTypeToAdd === 'good') {
              setGoodBehaviors(goodBehaviors.map(b => 
                b.id === behaviorToEdit.id ? { ...newBehavior, id: b.id } : b
              ));
            } else {
              setBadBehaviors(badBehaviors.map(b => 
                b.id === behaviorToEdit.id ? { ...newBehavior, id: b.id } : b
              ));
            }
            
            // Reset editing state
            setIsEditingBehavior(false);
            setBehaviorToEdit(null);
          } else {
            // Add new behavior
            if (behaviorTypeToAdd === 'good') {
              const newId = Math.max(0, ...goodBehaviors.map(b => b.id)) + 1;
              setGoodBehaviors([...goodBehaviors, { ...newBehavior, id: newId }]);
            } else {
              const newId = Math.max(0, ...badBehaviors.map(b => b.id)) + 1;
              setBadBehaviors([...badBehaviors, { ...newBehavior, id: newId }]);
            }
          }

          setNewBehavior({ description: "", points: 1, icon: "⭐" });
          setIsAddingBehavior(false);
        }
      };

      // Start editing a behavior
      const startEditBehavior = (behavior, type) => {
        setBehaviorTypeToAdd(type);
        setBehaviorToEdit(behavior);
        setNewBehavior({
          description: behavior.description,
          points: behavior.points,
          icon: behavior.icon
        });
        setIsEditingBehavior(true);
        setIsAddingBehavior(true);
        setShowIconPicker(false);
      };

      // Delete a behavior
      const deleteBehavior = (id, type) => {
        if (type === 'good') {
          setGoodBehaviors(goodBehaviors.filter(b => b.id !== id));
          if (selectedGoodBehavior === id) setSelectedGoodBehavior(null);
        } else {
          setBadBehaviors(badBehaviors.filter(b => b.id !== id));
          if (selectedBadBehavior === id) setSelectedBadBehavior(null);
        }
      };

      // Claim a reward
      const claimReward = (id) => {
        const reward = rewards.find(r => r.id === id);

        if (reward && currentPoints >= reward.points) {
          setRewards(rewards.map(r =>
            r.id === id ? { ...r, claimed: true } : r
          ));
          setCurrentPoints(prev => prev - reward.points);
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 3000);
        }
      };

      // Add a new reward
      const addReward = () => {
        if (newReward.name && newReward.points > 0) {
          const newId = Math.max(0, ...rewards.map(r => r.id)) + 1;
          setRewards([...rewards, { ...newReward, id: newId, claimed: false }]);
          setNewReward({ name: "", points: 0, icon: "🎁" });
          setIsAddingReward(false);
        }
      };

      // Reset a claimed reward
      const resetReward = (id) => {
        setRewards(rewards.map(r =>
          r.id === id ? { ...r, claimed: false } : r
        ));
      };

      // Generate the calendar grid
      const renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDayOfMonth = getFirstDayOfMonth(year, month);

        const days = [];

        // Get the most current kid data directly from state
        const currentKidData = kidsData[activeKidId] || {};
        const currentBehaviors = currentKidData.behaviors || {};
        
        console.log(`CALENDAR RENDER - kid:${activeKid.name}(${activeKidId}), month:${month}, year:${year}`);
        console.log(`CALENDAR RENDER - current behaviors:`, currentBehaviors);

        // Add empty cells for the days before the first day of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
          days.push(<div key={`empty-${i}-${activeKidId}-${month}-${renderTrigger}`} className="h-12 md:h-16"></div>);
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dateKey = formatDateKey(date);
          
          // Get day behaviors directly from current state
          const dayBehaviors = currentBehaviors[dateKey] || { good: 0, bad: 0 };

          // Log when behaviors exist for a day
          if (dayBehaviors.good > 0 || dayBehaviors.bad > 0) {
            console.log(`CALENDAR RENDER - Day ${day} behaviors:`, dayBehaviors);
          }

          const isSelected =
            selectedDate.getDate() === day &&
            selectedDate.getMonth() === month &&
            selectedDate.getFullYear() === year;

          // Include renderTrigger in the key to force re-render when it changes
          days.push(
            <div 
              key={`${activeKidId}-day-${day}-${month}-${renderTrigger}-g${dayBehaviors.good}-b${dayBehaviors.bad}`} 
              className={`calendar-day h-12 md:h-16 border rounded-lg flex flex-col items-center justify-center cursor-pointer ${isSelected ? 'bg-blue-200 border-blue-500' :
                dayBehaviors.good > dayBehaviors.bad ? 'bg-green-100' :
                  dayBehaviors.bad > 0 ? 'bg-red-100' : 'bg-white'
              }`}
              onClick={() => setSelectedDate(date)}
            >
              <div className="font-bold text-lg">{day}</div>
              {dayBehaviors.good > 0 && (
                <div className="flex items-center">
                  <span className="text-green-500 text-xs">+{dayBehaviors.good}</span>
                </div>
              )}
              {dayBehaviors.bad > 0 && (
                <div className="flex items-center">
                  <span className="text-red-500 text-xs">-{dayBehaviors.bad}</span>
                </div>
              )}
            </div>
          );
        }

        return days;
      };

      // Format the month name
      const formatMonth = (date) => {
        return date.toLocaleString('default', { month: 'long', year: 'numeric' });
      };

      // Navigate to previous or next month
      const changeMonth = (increment) => {
        const newDate = new Date(currentDate);
        newDate.setMonth(newDate.getMonth() + increment);
        setCurrentDate(newDate);
      };

      // Render daily behavior logs
      const renderDailyLogs = () => {
        const dateKey = formatDateKey(selectedDate);
        
        // Get the most current kid data directly from state
        const currentKidData = kidsData[activeKidId] || {};
        const currentLogs = currentKidData.dailyBehaviorLogs || {};
        const logs = currentLogs[dateKey] || [];
        
        console.log(`LOGS RENDER - kid:${activeKid.name}(${activeKidId}), date:${dateKey}, logs found:${logs.length}`);
        if (logs.length > 0) {
          console.log(`LOGS RENDER - Actual logs data:`, logs);
        }

        if (logs.length === 0) {
          return (
            <div className="text-gray-500 text-center py-4">
              No behaviors recorded for this day
            </div>
          );
        }

        return (
          <div className="max-h-60 overflow-y-auto mt-4">
            {
              logs.map((log) => (
                <div 
                  key={`${activeKidId}-log-${log.id}-${renderTrigger}`} 
                  className={`flex items-center p-2 my-1 rounded-lg ${log.type === 'good' ? 'bg-green-50' : 'bg-red-50'
                  }`}
                >
                  <span className="text-xl mr-2"> {log.icon} </span>
                  <div className="flex-1">
                    <div className="font-medium"> {log.description} </div>
                    <div className="text-xs text-gray-500"> {log.timestamp} </div>
                  </div>
                  <div className={`font-bold ${log.type === 'good' ? 'text-green-600' : 'text-red-600'
                    }`
                  }>
                    {log.type === 'good' ? '+' : '-'}{log.points}
                  </div>
                  {/* Delete button */}
                  <button 
                    onClick={() => removeBehavior(log.id)}
                    className="ml-2 text-gray-400 hover:text-red-500 transition-colors"
                    title="Remove behavior"
                  >
                    🗑️
                  </button>
                </div>
              ))
            }
          </div>
        );
      };

      // Render Icon Picker Modal
      const renderIconPicker = () => {
        if (!showIconPicker) return null;
        
        // Component that uses emoji-mart
        const CustomEmojiPicker = () => {
          const containerRef = React.useRef();
          
          // Log when rendered for debugging
          console.log('Rendering emoji picker component');
          
          React.useEffect(() => {
            if (containerRef.current) {
              // Clear any existing content
              containerRef.current.innerHTML = '';
              
              try {
                // Check if emoji-mart is available
                const emojiMartLib = window.EmojiMart || window.emojiMart;
                
                if (emojiMartLib) {
                  console.log('Using emoji-mart from CDN');
                  
                  // Create container for the picker
                  const pickerContainer = document.createElement('div');
                  pickerContainer.className = 'emoji-mart-container';
                  containerRef.current.appendChild(pickerContainer);
                  
                  // Create the picker
                  const picker = new emojiMartLib.Picker({
                    onEmojiSelect: (emoji) => {
                      console.log('Emoji selected:', emoji);
                      
                      // Safely extract the emoji character
                      let emojiChar = emoji.native || '';
                      if (!emojiChar && emoji.unified) {
                        // Convert unified format to actual unicode character
                        const codePoints = emoji.unified.split('-').map(hex => parseInt(hex, 16));
                        emojiChar = String.fromCodePoint(...codePoints);
                      }
                      
                      console.log('Setting emoji to:', emojiChar);
                      
                      // Update the behavior with the selected emoji
                      if (emojiChar) {
                        setNewBehavior(prev => ({...prev, icon: emojiChar}));
                        
                        // Close after a short delay
                        setTimeout(() => {
                          setShowIconPicker(false);
                        }, 100);
                      }
                    },
                    theme: 'light',
                    set: 'native',
                    previewPosition: 'none',
                    skinTonePosition: 'none',
                    maxFrequentRows: 0,
                    perLine: 8
                  });
                  
                  // Append the picker to our container
                  pickerContainer.appendChild(picker);
                } else {
                  // Fall back to custom implementation
                  console.warn('Emoji-mart not available, using fallback picker');
                  renderCustomEmojiPicker();
                }
              } catch (e) {
                console.error('Error rendering emoji picker:', e);
                containerRef.current.textContent = 'Failed to load emoji picker';
                
                // Display detailed error to help debug
                const errorDetails = document.createElement('pre');
                errorDetails.style.color = 'red';
                errorDetails.style.fontSize = '12px';
                errorDetails.style.maxHeight = '100px';
                errorDetails.style.overflow = 'auto';
                errorDetails.textContent = e.toString() + '\n' + (e.stack || '');
                containerRef.current.appendChild(errorDetails);
              }
            }
            
            // Custom emoji picker implementation as fallback
            function renderCustomEmojiPicker() {
              // Create a simple emoji grid
              const emojis = ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", 
                         "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", 
                         "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩",
                         "🥳", "😏", "😒", "😞", "😔", "😟", "😕", "🙁", "☹️", "😣",
                         "👍", "👎", "👏", "🙌", "👐", "🤲", "🤝", "🙏", "✌️", "🤞",
                         "🌟", "⭐", "✨", "💫", "🔥", "❤️", "🧡", "💛", "💚", "💙",
                         "🏆", "🥇", "🥈", "🥉", "🎖", "🏅", "🎯", "🎮", "🎲", "🧩",
                         "📚", "📖", "📝", "✏️", "📌", "📍", "🧷", "📎", "🖇", "📐",
                         "🧹", "🧼", "🧽", "🧴", "🛁", "🚿", "🚽", "🧻", "🧯", "🧸"];
              
              // Create emoji grid container
              const gridContainer = document.createElement('div');
              gridContainer.style.display = 'grid';
              gridContainer.style.gridTemplateColumns = 'repeat(8, 1fr)';
              gridContainer.style.gap = '4px';
              gridContainer.style.padding = '6px';
              gridContainer.style.maxHeight = '250px';
              gridContainer.style.overflowY = 'scroll';
              gridContainer.style.scrollbarWidth = 'none'; // Firefox
              gridContainer.style.msOverflowStyle = 'none'; // IE and Edge
              
              // Hide WebKit scrollbar
              const styleSheet = document.createElement('style');
              styleSheet.textContent = '.custom-emoji-grid::-webkit-scrollbar { display: none; }';
              document.head.appendChild(styleSheet);
              gridContainer.classList.add('custom-emoji-grid');
              
              // Create search input
              const searchInput = document.createElement('input');
              searchInput.type = 'text';
              searchInput.placeholder = 'Search emojis...';
              searchInput.style.width = '100%';
              searchInput.style.padding = '8px';
              searchInput.style.marginBottom = '8px';
              searchInput.style.borderRadius = '4px';
              searchInput.style.border = '1px solid #ccc';
              containerRef.current.appendChild(searchInput);
              
              // Add search functionality
              searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredEmojis = emojis.filter(emoji => 
                  emoji.toLowerCase().includes(searchTerm));
                
                // Clear grid
                gridContainer.innerHTML = '';
                
                // Rebuild grid with filtered emojis
                filteredEmojis.forEach(emoji => {
                  const emojiButton = createEmojiButton(emoji);
                  gridContainer.appendChild(emojiButton);
                });
              });
              
              // Function to create emoji buttons
              function createEmojiButton(emoji) {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.style.fontSize = '24px';
                button.style.padding = '4px';
                button.style.border = 'none';
                button.style.background = 'none';
                button.style.cursor = 'pointer';
                button.style.borderRadius = '4px';
                button.style.transition = 'all 0.2s ease';
                button.style.width = '30px';
                button.style.height = '30px';
                button.style.display = 'flex';
                button.style.alignItems = 'center';
                button.style.justifyContent = 'center';
                
                button.addEventListener('mouseover', () => {
                  button.style.backgroundColor = '#f0f0f0';
                  button.style.transform = 'scale(1.1)';
                });
                
                button.addEventListener('mouseout', () => {
                  button.style.backgroundColor = 'transparent';
                  button.style.transform = 'scale(1)';
                });
                
                button.addEventListener('click', () => {
                  console.log('Custom emoji selected:', emoji);
                  setNewBehavior(prev => ({...prev, icon: emoji}));
                  setShowIconPicker(false);
                });
                
                return button;
              }
              
              // Add emojis to grid
              emojis.forEach(emoji => {
                const emojiButton = createEmojiButton(emoji);
                gridContainer.appendChild(emojiButton);
              });
              
              // Add search and grid to container
              containerRef.current.appendChild(gridContainer);
            }
          }, []);
          
          return <div ref={containerRef} className="simple-emoji-picker no-scrollbar"></div>;
        };
        
        return (
          <div className="relative">
            <div 
              className="emoji-popup p-3 no-scrollbar"
              onClick={(e) => e.stopPropagation()} 
              ref={iconPickerRef}
            >
              <div className="flex justify-between items-center mb-2">
                <h2 className="text-sm font-bold">Select an Icon</h2>
                <button
                  onClick={() => setShowIconPicker(false)}
                  className="text-lg hover:text-gray-700">
                  ×
                </button>
              </div>
              
              {/* Custom emoji picker component */}
              <CustomEmojiPicker />
            </div>
          </div>
        );
      };

      // Render behavior manager modal (modified version with icon picker)
      const renderBehaviorManager = () => {
        if (!showBehaviorManager) return null;

        return (
          <div className="modal-backdrop">
            <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold"> Behavior Manager </h2>
                <button
                  onClick={() => setShowBehaviorManager(false)}
                  className="text-2xl hover:text-gray-700">
                  ×
                </button>
              </div>

              {/* Tabs for switching between good and bad behaviors */}
              <div className="flex mb-4">
                <button 
                        className={
                  `flex-1 py-2 rounded-tl-lg rounded-bl-lg font-medium ${behaviorTypeToAdd === 'good'
                    ? 'bg-green-500 text-white'
                    : 'bg-gray-200'
                  }`
                }
                onClick={() => setBehaviorTypeToAdd('good')}
                >
                  Good Behaviors
                </button>
                <button
                  className={`flex-1 py-2 rounded-tr-lg rounded-br-lg font-medium ${behaviorTypeToAdd === 'bad'
                    ? 'bg-red-500 text-white'
                    : 'bg-gray-200'
                  }`}
                  onClick={() => setBehaviorTypeToAdd('bad')}
                >
                  Needs Improvement
                </button>
              </div>

              {/* List of behaviors */}
              <div className="mb-4">
                {behaviorTypeToAdd === 'good' ? (
                  goodBehaviors.length > 0 ? (
                    goodBehaviors.map(behavior => (
                      <div 
                                key={behavior.id} 
                                className="behavior-card flex items-center justify-between p-3 my-2 bg-green-50 rounded-lg"
                      >
                        <div className="flex items-center">
                          <span className="text-2xl mr-3"> {behavior.icon} </span>
                          <div>
                            <div className="font-medium"> {behavior.description} </div>
                            <div className="text-sm text-green-600"> +{behavior.points} stars </div>
                          </div>
                        </div>
                        <div className="flex">
                          <button 
                            onClick={() => startEditBehavior(behavior, 'good')}
                            className="text-blue-500 hover:text-blue-700 text-lg mr-2"
                            title="Edit behavior"
                          >
                            ✏️
                          </button>
                          <button 
                            onClick={() => deleteBehavior(behavior.id, 'good')}
                            className="text-red-500 hover:text-red-700 text-lg"
                            title="Delete behavior"
                          >
                            🗑️
                          </button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-4 text-gray-500">
                      No good behaviors added yet
                    </div>
                  )
                ) : (
                  badBehaviors.length > 0 ? (
                    badBehaviors.map(behavior => (
                      <div 
                                key={behavior.id} 
                                className="behavior-card flex items-center justify-between p-3 my-2 bg-red-50 rounded-lg"
                      >
                        <div className="flex items-center">
                          <span className="text-2xl mr-3"> {behavior.icon} </span>
                          <div>
                            <div className="font-medium"> {behavior.description} </div>
                            <div className="text-sm text-red-600"> -{behavior.points} stars </div>
                          </div>
                        </div>
                        <div className="flex">
                          <button 
                            onClick={() => startEditBehavior(behavior, 'bad')}
                            className="text-blue-500 hover:text-blue-700 text-lg mr-2"
                            title="Edit behavior"
                          >
                            ✏️
                          </button>
                          <button 
                            onClick={() => deleteBehavior(behavior.id, 'bad')}
                            className="text-red-500 hover:text-red-700 text-lg"
                            title="Delete behavior"
                          >
                            🗑️
                          </button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-4 text-gray-500">
                      No behaviors that need improvement added yet
                    </div>
                  )
                )}
              </div>

              {/* Add new behavior form - updated with icon picker button */}
              {
                isAddingBehavior ? (
                  <div className="p-4 border-2 border-dashed border-blue-300 rounded-lg">
                    <h3 className="font-bold mb-3">{isEditingBehavior ? 'Edit Behavior' : 'Add New Behavior'}</h3>
                    <div className="flex mb-2 items-center">
                      <div className="relative mr-2">
                        <div 
                          className="w-16 p-2 border rounded-lg text-center text-xl cursor-pointer flex justify-center items-center hover:bg-gray-50"
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowIconPicker(true);
                          }}
                        >
                          {newBehavior.icon || "⭐"}
                        </div>
                        <div className="absolute -right-1 -bottom-1 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer hover:bg-blue-600" onClick={(e) => {
                          e.stopPropagation();
                          setShowIconPicker(true);
                        }}>
                          +
                        </div>
                        {renderIconPicker()}
                      </div>
                      <input
                        type="text"
                        placeholder="Behavior description"
                        value={newBehavior.description}
                        onChange={e => setNewBehavior({ ...newBehavior, description: e.target.value })}
                        className="flex-1 p-2 border rounded-lg"
                      />
                    </div>
                    <div className="flex mb-2 items-center">
                      <span className="mr-2"> Stars: </span>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={newBehavior.points}
                        onChange={e => setNewBehavior({ ...newBehavior, points: parseInt(e.target.value) || 1})}
                        className="flex-1 p-2 border rounded-lg"
                      />
                    </div>
                    <div className="flex justify-end mt-4 space-x-2">
                      <button
                        onClick={() => {
                          setIsAddingBehavior(false);
                          setIsEditingBehavior(false);
                          setBehaviorToEdit(null);
                          setNewBehavior({ description: "", points: 1, icon: "⭐" });
                        }}
                        className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={addBehavior}
                        className={`px-4 py-2 rounded-lg ${behaviorTypeToAdd === 'good'
                          ? 'bg-green-500 hover:bg-green-600 text-white'
                          : 'bg-red-500 hover:bg-red-600 text-white'
                          }`}
                      >
                        {isEditingBehavior ? 'Save Changes' : 'Add Behavior'}
                      </button>
                    </div>
                  </div>
                ) : (
                  <button
                    onClick={() => {
                      setIsAddingBehavior(true);
                      setNewBehavior({ description: "", points: 1, icon: "⭐" });
                    }}
                    className={`w-full py-2 rounded-lg ${behaviorTypeToAdd === 'good'
                      ? 'bg-green-100 hover:bg-green-200 text-green-700'
                      : 'bg-red-100 hover:bg-red-200 text-red-700'
                      }`}
                  >
                    + Add {behaviorTypeToAdd === 'good' ? 'Good Behavior' : 'Behavior to Improve'}
                  </button>
                )
              }
            </div>
          </div>
        );
      };

      // Setup wizard component
      const renderSetupWizard = () => {
        // Setup step titles
        const stepTitles = [
          "Welcome to Star Behavior Tracker!",
          "Let's Add Your First Child",
          "Setup Complete!"
        ];
        
        // Temporary child data for setup
        // const [setupChild, setSetupChild] = React.useState({ name: "", avatar: "👶" });
        
        // Handle completing setup
        const completeSetup = () => {
          // Add the child if name is provided
          if (setupChild.name.trim()) {
            // Create initial kid
            const newKid = { 
              id: 1, 
              name: setupChild.name.trim(), 
              avatar: setupChild.avatar 
            };
            
            // Set the new kid
            setKids([newKid]);
            setActiveKidId(1);
            
            // Initialize data structure for the new kid with defaults
            const initialKidsData = {
              1: {
                points: 0,
                behaviors: {},
                dailyBehaviorLogs: {},
                goodBehaviors: [
                  { id: 1, description: "Cleaning up toys", points: 2, icon: "🧹" },
                  { id: 2, description: "Helping a sibling", points: 3, icon: "🤝" },
                  { id: 3, description: "Completing homework", points: 2, icon: "📚" },
                  { id: 4, description: "Brushing teeth without reminder", points: 1, icon: "🪥" },
                  { id: 5, description: "Setting the table", points: 1, icon: "🍽️" }
                ],
                badBehaviors: [
                  { id: 1, description: "Not listening", points: 1, icon: "👂" },
                  { id: 2, description: "Fighting with siblings", points: 2, icon: "😠" },
                  { id: 3, description: "Not finishing food", points: 1, icon: "🍽️" },
                  { id: 4, description: "Screen time without permission", points: 2, icon: "📱" },
                  { id: 5, description: "Bedtime tantrum", points: 3, icon: "😭" }
                ],
                rewards: [
                  { id: 1, name: "Playground Time", points: 20, claimed: false, icon: "🛝" },
                  { id: 2, name: "Ice Cream", points: 30, claimed: false, icon: "🍦" },
                  { id: 3, name: "Movie Night", points: 50, claimed: false, icon: "🎬" },
                  { id: 4, name: "New Toy", points: 100, claimed: false, icon: "🧸" }
                ]
              }
            };
            
            setKidsData(initialKidsData);
            
            // Immediately save to localStorage to prevent setup showing again
            saveAppState([newKid], 1, initialKidsData);
          }
          
          // Exit setup mode
          setShowSetupWizard(false);
        };
        
        // Step content based on current step
        const renderStepContent = () => {
          switch (setupStep) {
            case 1: // Welcome screen
              return (
                <div className="text-center">
                  <div className="mb-8 animate-bounce">
                    <div className="text-8xl inline-flex justify-center items-center">
                      <span className="text-yellow-400">⭐</span>
                      <span className="mx-2 text-6xl">👧</span>
                      <span className="text-yellow-400">⭐</span>
                    </div>
                  </div>
                  <h2 className="text-3xl font-bold mb-6 text-purple-600">Welcome to Star Behavior Tracker!</h2>
                  <p className="mb-4 text-lg">
                    This app helps you track your children's behavior, award points for good behavior,
                    and track areas that need improvement.
                  </p>
                  <p className="mb-8 text-lg">
                    Let's get started by setting up your first child profile!
                  </p>
                  <div className="flex justify-center space-x-4">
                    <button
                      onClick={() => setSetupStep(2)}
                      className="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg text-xl"
                    >
                      Get Started
                    </button>
                    <button
                      onClick={() => {
                        // Set a default profile and complete setup
                        setSetupChild({ name: "My Child", avatar: "👧" });
                        setSetupStep(3);
                      }}
                      className="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg text-xl"
                    >
                      Quick Setup
                    </button>
                  </div>
                </div>
              );
              
            case 2: // Add child
              return (
                <div>
                  <h2 className="text-3xl font-bold mb-6 text-purple-600 text-center">Add Your Child</h2>
                  <div className="bg-white p-6 rounded-lg shadow-lg max-w-md mx-auto">
                    <div className="flex mb-4 items-center">
                      <label className="w-24 text-lg">Avatar:</label>
                      <div className="flex-1">
                        <div className="flex items-center">
                          <div className="w-16 h-16 flex items-center justify-center text-3xl border rounded-lg mr-3">
                            {setupChild.avatar}
                          </div>
                          <select
                            value={setupChild.avatar}
                            onChange={e => setSetupChild({...setupChild, avatar: e.target.value})}
                            className="p-2 border rounded-lg flex-1"
                          >
                            {["👧", "👦", "👶", "👼", "🧒", "👪", "🧚", "🦸", "🦹", "🧝"].map(emoji => (
                              <option key={emoji} value={emoji}>{emoji}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex mb-6 items-center">
                      <label className="w-24 text-lg">Name:</label>
                      <input
                        type="text"
                        placeholder="Enter child's name"
                        value={setupChild.name}
                        onChange={e => setSetupChild({...setupChild, name: e.target.value})}
                        className="flex-1 p-2 border rounded-lg"
                      />
                    </div>
                    
                    <div className="flex justify-between">
                      <button
                        onClick={() => setSetupStep(1)}
                        className="bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg"
                      >
                        Back
                      </button>
                      <button
                        onClick={() => {
                          if (setupChild.name.trim()) {
                            setSetupStep(3);
                          } else {
                            alert("Please enter your child's name");
                          }
                        }}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
                      >
                        Next
                      </button>
                    </div>
                  </div>
                </div>
              );
              
            case 3: // Completion
              return (
                <div className="text-center">
                  <h2 className="text-3xl font-bold mb-6 text-purple-600">All Set!</h2>
                  <p className="mb-4 text-lg">
                    You're all set up and ready to start tracking {setupChild.name}'s behavior!
                  </p>
                  <div className="flex justify-center items-center text-5xl my-8">
                    {setupChild.avatar} ⭐ 🎉
                  </div>
                  <p className="mb-8 text-lg">
                    Press the button below to start using the Star Behavior Tracker.
                  </p>
                  <div className="flex justify-center">
                    <button
                      onClick={completeSetup}
                      className="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg text-xl"
                    >
                      Start Tracking
                    </button>
                  </div>
                </div>
              );
              
            default:
              return null;
          }
        };
        
        // Progress indicator
        const renderProgressBar = () => {
          return (
            <div className="mb-8">
              <div className="flex justify-between mb-1">
                {stepTitles.map((title, index) => (
                  <div 
                    key={index} 
                    className={`text-sm ${index + 1 === setupStep ? 'font-bold text-purple-600' : 'text-gray-500'}`}
                  >
                    Step {index + 1}
                  </div>
                ))}
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2.5">
                <div 
                  className="bg-purple-600 h-2.5 rounded-full transition-all" 
                  style={{ width: `${((setupStep - 1) / (stepTitles.length - 1)) * 100}%` }}
                ></div>
              </div>
            </div>
          );
        };
        
        return (
          <div className="max-w-4xl mx-auto my-8">
            {renderProgressBar()}
            <div className="bg-blue-50 p-8 rounded-xl shadow-lg">
              {renderStepContent()}
            </div>
          </div>
        );
      };
      
      // Render the app
      return (
        <div className="container mx-auto p-4 relative">
          {showSetupWizard ? (
            renderSetupWizard()
          ) : (
            <>
              {/* Header */}
              <div className="text-center mb-6">
                <h1 className="app-title text-4xl md:text-5xl mb-2"> Star Behavior Tracker </h1>
                <div className="flex justify-center items-center mb-4">
                  <div className="flex items-center">
                    <span className="text-2xl mr-2">{activeKid.avatar}</span>
                    <div 
                      className="bg-white border border-purple-300 rounded-lg px-3 py-2 text-center text-xl font-bold outline-none focus:border-purple-500 cursor-pointer"
                      onClick={() => setShowKidManager(true)}
                    >
                      {activeKid.name}
                    </div>
                    <button 
                      onClick={() => setShowKidManager(true)}
                      className="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded-lg text-sm"
                      title="Manage children"
                    >
                      Manage Kids
                    </button>
                  </div>
                </div>
                <div className="bg-gradient-to-r from-purple-600 to-blue-500 text-white py-2 px-4 rounded-full inline-flex items-center">
                  <span className="mr-2"> Total Stars: </span>
                    <span className="font-bold text-xl"> {currentPoints} ⭐</span>
                </div>
              </div>

              {/* Main Content */}
              <div className="md:flex gap-6">
                {/* Calendar Section */}
                <div className="md:w-3/5 bg-white p-4 rounded-xl shadow-lg mb-6 md:mb-0">
                  <div className="flex justify-between items-center mb-4">
                    <button 
                            onClick={() => changeMonth(-1)}
                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                              &larr;
                    </button>
                    <h2 className="text-2xl font-bold text-center"> {formatMonth(currentDate)} </h2>
                    <button
                      onClick={() => changeMonth(1)}
                      className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                              &rarr;
                    </button>
                  </div>

                  {/* Day names */}
                  <div className="grid grid-cols-7 gap-2 mb-2">
                    {
                      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                        <div key={day} className="text-center font-bold"> {day} </div>
                      ))
                    }
                  </div>

                  {/* Calendar grid - Use renderTrigger in key */}
                  <div 
                    className="grid grid-cols-7 gap-2" 
                    key={`calendar-grid-${activeKidId}-${currentDate.getMonth()}-${currentDate.getFullYear()}-${renderTrigger}`}
                  >
                    {renderCalendar()}
                  </div>

                  {/* Selected date behavior */}
                  <div className="mt-6 bg-blue-50 p-4 rounded-lg">
                    <div className="flex justify-between items-center">
                      <h3 className="text-xl font-bold">
                        {
                          selectedDate.toLocaleDateString('en-US', {
                            weekday: 'long',
                            month: 'long',
                            day: 'numeric'
                          })
                        }
                      </h3>

                      <button
                        onClick={() => setShowBehaviorManager(true)}
                        className="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-lg text-sm">
                        Manage Behaviors
                      </button>
                    </div>

                    <div className="flex space-x-4 mt-4">
                      <button 
                        className={
                          `flex-1 py-3 rounded-lg font-bold flex items-center justify-center ${activeBehavior === 'good'
                            ? 'bg-green-500 text-white'
                            : 'bg-green-100 text-green-700'
                          }`
                        }
                        onClick={() => {
                          setActiveBehavior('good');
                          setSelectedBadBehavior(null); // Reset bad behavior selection when switching
                        }}
                      >
                        Good Behavior 😊
                      </button>
                      <button
                        className={`flex-1 py-3 rounded-lg font-bold flex items-center justify-center ${activeBehavior === 'bad'
                          ? 'bg-red-500 text-white'
                          : 'bg-red-100 text-red-700'
                        }`}
                        onClick={() => {
                          setActiveBehavior('bad');
                          setSelectedGoodBehavior(null); // Reset good behavior selection when switching
                        }}
                      >
                        Needs Improvement 😟
                      </button>
                    </div>

                    {/* Behavior selection */}
                    <div className="mt-4">
                      <div className="text-sm font-bold mb-2">
                        Select behavior:
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {activeBehavior === 'good' ? (
                          goodBehaviors.length > 0 ? (
                            goodBehaviors.map(behavior => (
                              <div 
                                key={behavior.id} 
                                className={`behavior-tag px-3 py-2 rounded-lg cursor-pointer flex items-center ${selectedGoodBehavior === behavior.id
                                  ? 'bg-green-500 text-white'
                                  : 'bg-green-100 text-green-700'
                                }`}
                                onClick={() => setSelectedGoodBehavior(behavior.id)}
                              >
                                <span className="mr-2"> {behavior.icon} </span>
                                <span> {behavior.description} </span>
                                <span className="ml-2 bg-green-200 text-green-800 px-1 rounded"> +{behavior.points} </span>
                              </div>
                            ))
                          ) : (
                            <div className="text-gray-500 italic">
                              No good behaviors added yet. Use the Manage Behaviors button to add some.
                            </div>
                          )
                        ) : (
                          badBehaviors.length > 0 ? (
                            badBehaviors.map(behavior => (
                              <div 
                                key={behavior.id} 
                                className={`behavior-tag px-3 py-2 rounded-lg cursor-pointer flex items-center ${selectedBadBehavior === behavior.id
                                  ? 'bg-red-500 text-white'
                                  : 'bg-red-100 text-red-700'
                                }`}
                                onClick={() => setSelectedBadBehavior(behavior.id)}
                              >
                                <span className="mr-2"> {behavior.icon} </span>
                                <span> {behavior.description} </span>
                                <span className="ml-2 bg-red-200 text-red-800 px-1 rounded"> -{behavior.points} </span>
                              </div>
                            ))
                          ) : (
                            <div className="text-gray-500 italic">
                              No behaviors that need improvement added yet. Use the Manage Behaviors button to add some.
                            </div>
                          )
                        )}
                      </div>
                    </div>

                    <button
                      onClick={recordBehavior}
                      className={`w-full mt-4 py-3 rounded-lg font-bold ${activeBehavior === 'good'
                          ? 'bg-green-500 hover:bg-green-600 text-white'
                          : 'bg-red-500 hover:bg-red-600 text-white'
                        }`}
                    >
                      {activeBehavior === 'good'
                        ? 'Record Good Behavior'
                        : 'Record Needs Improvement'}
                    </button>

                    {/* Daily logs - Use renderTrigger in key */}
                    <div className="mt-4">
                      <h3 className="text-lg font-bold mb-2"> Today's Behaviors:</h3>
                      <div 
                        key={`daily-logs-${activeKidId}-${formatDateKey(selectedDate)}-${renderTrigger}`}
                      >
                        {renderDailyLogs()}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Rewards Section */}
                <div className="md:w-2/5 bg-white p-4 rounded-xl shadow-lg">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold"> Rewards </h2>
                    <button
                      onClick={() => setIsAddingReward(!isAddingReward)}
                      className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg">
                      {isAddingReward ? 'Cancel' : 'Add Reward'}
                    </button>
                  </div>

                  {/* Add new reward form */}
                  {
                    isAddingReward && (
                      <div className="mb-4 p-3 border-2 border-dashed border-blue-300 rounded-lg">
                        <div className="flex mb-2 items-center">
                          <input
                                    type="text"
                            placeholder="Icon"
                            value={newReward.icon}
                            onChange={e => setNewReward({ ...newReward, icon: e.target.value })}
                            className="w-16 p-2 border rounded-lg mr-2 text-center text-xl"
                          />
                          <input
                                    type="text"
                            placeholder="Reward name"
                            value={newReward.name}
                            onChange={e => setNewReward({ ...newReward, name: e.target.value })}
                            className="flex-1 p-2 border rounded-lg"
                          />
                        </div>
                        <div className="flex mb-2 items-center">
                          <span className="mr-2"> Stars needed: </span>
                            <input
                              type="number"
                              min="1"
                              value={newReward.points}
                              onChange={e => setNewReward({ ...newReward, points: parseInt(e.target.value) || 0})}
                              className="flex-1 p-2 border rounded-lg"
                            />
                        </div>
                        <button
                          onClick={addReward}
                          className="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
                          Add Reward
                        </button>
                      </div>
                    )
                  }

                  {/* Rewards list */}
                  <div className="grid grid-cols-1 gap-4">
                    {
                      rewards.map(reward => (
                        <div 
                                key={reward.id} 
                                className={`reward-card p-4 ${reward.claimed
                            ? 'bg-gray-100'
                            : 'bg-blue-50'
                          } rounded-lg shadow-sm`}
                        >
                          <div className="flex items-center mb-2">
                            <span className="text-3xl mr-3"> {reward.icon} </span>
                            <h3 className="font-bold text-lg flex-1"> {reward.name} </h3>
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm font-bold">
                              {reward.points} ⭐
                            </span>
                          </div>

                          {
                            reward.claimed ? (
                              <div className="flex space-x-2">
                                <div className="flex-1 bg-green-100 text-green-800 py-2 rounded-lg text-center font-bold">
                                  Claimed!
                                </div>
                                <button
                                  onClick={() => resetReward(reward.id)}
                                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg">
                                  Reset
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => claimReward(reward.id)}
                                className={`w-full py-2 rounded-lg font-bold ${currentPoints >= reward.points
                                    ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white hover:opacity-90'
                                    : 'bg-gray-200 text-gray-500 cursor-not-allowed'
                                  }`}
                                disabled={currentPoints < reward.points}
                              >
                                {currentPoints >= reward.points
                                  ? 'Claim Reward!'
                                  : `Need ${reward.points - currentPoints} more stars`}
                              </button>
                            )
                          }
                        </div>
                      ))
                    }

                    {
                      rewards.length === 0 && (
                        <div className="text-center py-4 text-gray-500">
                          No rewards added yet
                        </div>
                      )
                    }
                  </div>
                </div>
              </div>

              {/* Kid management modal */}
              {renderKidManager()}

              {/* Behavior management modal */}
              {renderBehaviorManager()}

              {/* Confetti effect */}
              {
                showConfetti && (
                  <div className="fixed inset-0 pointer-events-none z-50">
                    {
                      Array.from({ length: 50 }).map((_, i) => (
                        <div
                                key={i}
                                className="absolute"
                                style={{
                                left: `${Math.random() * 100}%`,
                                top: '-20px',
                                width: `${Math.random() * 20 + 10}px`,
                                height: `${Math.random() * 20 + 10}px`,
                                backgroundColor: ['#FFD700', '#4338CA', '#3B82F6', '#EC4899'][Math.floor(Math.random() * 4)],
                                borderRadius: '50%',
                                animation: `fall ${Math.random() * 3 + 2}s linear forwards`,
                                animationDelay: `${Math.random() * 2}s`
                              }}
                        />
                      ))
                    }
                  </div>
                )
              }
              
              {/* Accessibility toggle for background animation */}
              <div className="fixed bottom-2 right-2 z-40">
                <button 
                  onClick={() => setUseSimpleBackground(!useSimpleBackground)}
                  className="text-xs bg-white/80 hover:bg-white/100 px-2 py-1 rounded-md shadow-sm text-gray-600"
                  title={useSimpleBackground ? "Enable particle animations" : "Switch to simple background"}
                >
                  {useSimpleBackground ? "🌟 Enable particles" : "🎨 Simple background"}
                </button>
              </div>

              {/* Footer with settings */}
              <div className="mt-8 pt-4 border-t border-gray-200">
                <div className="flex justify-center">
                  <button
                    onClick={() => {
                      if (confirm("Are you sure you want to reset the app? This will delete all your data and return to the initial setup.")) {
                        // Clear localStorage
                        localStorage.removeItem('kids');
                        localStorage.removeItem('activeKidId');
                        localStorage.removeItem('kidsData');
                        localStorage.removeItem('behaviors');
                        
                        // Show setup wizard again
                        setShowSetupWizard(true);
                        setSetupStep(1);
                      }
                    }}
                    className="text-red-500 hover:text-red-700 text-sm mx-2"
                  >
                    Reset App
                  </button>
                  <span className="text-gray-300 mx-2">|</span>
                  <button 
                    onClick={() => setUseSimpleBackground(!useSimpleBackground)}
                    className="text-blue-500 hover:text-blue-700 text-sm mx-2"
                  >
                    {useSimpleBackground ? "Enable Animated Background" : "Use Simple Background"}
                  </button>
                  <span className="text-gray-300 mx-2">|</span>
                  <span className="text-gray-500 text-sm mx-2">v2.0.0</span>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
    </script>
  </body>
</html>
